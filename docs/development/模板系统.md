# 模板系统文档

| 文档版本 | 1.0 |
|----------|-----|
| 创建日期 | 2026-02-09 |
| 项目名称 | MultiForms |
| 文档类型 | 功能文档 |

---

## 1. 概述

MultiForms 模板系统是一个基于数据库的动态模板库，允许管理员创建和管理表单模板，用户可以基于模板快速创建表单。

### 1.1 核心特性

- **数据库存储**：模板存储在 Supabase `templates` 表中
- **分类管理**：支持投票、问卷、评分、反馈、信息收集五种分类
- **实时同步**：使用 Supabase Realtime 实现模板实时更新
- **权限控制**：仅管理员可管理模板，所有用户可使用
- **使用统计**：记录每个模板的使用次数

---

## 2. 数据库结构

### 2.1 templates 表

```sql
CREATE TABLE templates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL CHECK (category IN ('vote', 'survey', 'rating', 'feedback', 'collection')),
  form_data JSONB NOT NULL,
  preview_image TEXT,
  is_featured BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  usage_count INTEGER DEFAULT 0,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_templates_category ON templates(category);
CREATE INDEX idx_templates_featured ON templates(is_featured) WHERE is_featured = TRUE;
CREATE INDEX idx_templates_active ON templates(is_active) WHERE is_active = TRUE;
```

### 2.2 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 模板唯一标识 |
| name | TEXT | 模板名称 |
| description | TEXT | 模板描述 |
| category | TEXT | 分类：vote(投票)/survey(问卷)/rating(评分)/feedback(反馈)/collection(信息收集) |
| form_data | JSONB | 表单定义数据（包含题目、设置等） |
| preview_image | TEXT | 预览图片 URL |
| is_featured | BOOLEAN | 是否为特色模板 |
| is_active | BOOLEAN | 是否启用（软删除） |
| usage_count | INTEGER | 使用次数统计 |
| created_by | UUID | 创建者 ID |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

---

## 3. API 接口

### 3.1 获取模板列表

```typescript
// src/lib/api/templates.ts
export async function getTemplates(options?: {
  category?: TemplateCategory
  featured?: boolean
  active?: boolean
  limit?: number
}): Promise<Template[]>
```

**参数**：
- `category`: 按分类筛选
- `featured`: 仅获取特色模板
- `active`: 仅获取启用的模板
- `limit`: 返回数量限制

### 3.2 获取单个模板

```typescript
export async function getTemplate(id: string): Promise<Template | null>
```

### 3.3 创建模板

```typescript
export async function createTemplate(template: CreateTemplateInput): Promise<Template>
```

**权限**：仅管理员

### 3.4 更新模板

```typescript
export async function updateTemplate(id: string, updates: UpdateTemplateInput): Promise<Template>
```

**权限**：仅管理员

### 3.5 删除模板

```typescript
export async function deleteTemplate(id: string): Promise<void>
```

**权限**：仅管理员（软删除，设置 is_active = false）

### 3.6 记录模板使用

```typescript
export async function recordTemplateUsage(id: string): Promise<void>
```

---

## 4. 前台页面

### 4.1 模板库页面

**路由**：`/templates`

**功能**：
- 展示所有启用的模板
- 按分类筛选
- 特色模板优先展示
- 点击"使用模板"创建新表单

**组件**：`src/app/templates/page.tsx`

### 4.2 使用模板流程

1. 用户在模板库选择模板
2. 点击"使用模板"按钮
3. 跳转到表单编辑器 (`/forms/new`)
4. 预填充模板的表单数据
5. 用户可修改后发布

---

## 5. 管理后台

### 5.1 模板管理页面

**路由**：`/admin/templates`

**功能**：
- 模板列表展示
- 创建新模板
- 编辑现有模板
- 删除模板（软删除）
- 设置特色模板
- 启用/禁用模板
- 查看使用统计

**组件**：`src/app/admin/templates/page.tsx`

### 5.2 管理操作

| 操作 | 说明 | API |
|------|------|-----|
| 创建 | 从现有表单创建模板或新建 | `createTemplate` |
| 编辑 | 修改模板名称、描述、分类、表单数据 | `updateTemplate` |
| 删除 | 软删除模板 | `deleteTemplate` |
| 特色标记 | 设置为特色模板 | `updateTemplate({ is_featured: true })` |
| 启用/禁用 | 控制模板是否对用户可见 | `updateTemplate({ is_active: false })` |

---

## 6. 实时同步

模板系统使用 Supabase Realtime 实现实时同步：

```typescript
// 订阅模板变更
const channel = supabase
  .channel('templates_changes')
  .on(
    'postgres_changes',
    {
      event: '*', // INSERT, UPDATE, DELETE
      schema: 'public',
      table: 'templates'
    },
    (payload) => {
      // 处理变更
      console.log('Template changed:', payload)
      // 刷新模板列表
      fetchTemplates()
    }
  )
  .subscribe()
```

**使用场景**：
- 管理员创建/编辑模板后，前台模板库实时更新
- 多个管理员同时管理模板时，实时看到变更

---

## 7. 类型定义

```typescript
// src/types/index.ts

export type TemplateCategory = 'vote' | 'survey' | 'rating' | 'feedback' | 'collection'

export interface Template {
  id: string
  name: string
  description: string | null
  category: TemplateCategory
  form_data: FormConfig
  preview_image: string | null
  is_featured: boolean
  is_active: boolean
  usage_count: number
  created_by: string
  created_at: string
  updated_at: string
}

export interface CreateTemplateInput {
  name: string
  description?: string
  category: TemplateCategory
  form_data: FormConfig
  preview_image?: string
  is_featured?: boolean
}

export interface UpdateTemplateInput {
  name?: string
  description?: string
  category?: TemplateCategory
  form_data?: FormConfig
  preview_image?: string
  is_featured?: boolean
  is_active?: boolean
}
```

---

## 8. 使用示例

### 8.1 从表单创建模板

```typescript
// 在表单编辑器中
const currentForm = getFormState()

const template = await createTemplate({
  name: '活动满意度调查',
  description: '适用于各类活动后的满意度收集',
  category: 'survey',
  form_data: currentForm,
  is_featured: true
})
```

### 8.2 使用模板创建表单

```typescript
// 在模板库页面
const handleUseTemplate = async (templateId: string) => {
  // 1. 获取模板
  const template = await getTemplate(templateId)

  // 2. 创建新表单
  const newForm = await createForm({
    title: template.name,
    description: template.description,
    questions: template.form_data.questions,
    settings: template.form_data.settings
  })

  // 3. 记录模板使用
  await recordTemplateUsage(templateId)

  // 4. 跳转到编辑器
  router.push(`/forms/${newForm.id}/edit`)
}
```

---

## 9. 最佳实践

### 9.1 模板设计原则

- **通用性**：模板应适用于多种场景
- **简洁性**：避免过多的题目，3-8题为佳
- **引导性**：提供清晰的示例题目和选项
- **美观性**：设置合适的默认样式

### 9.2 分类建议

| 分类 | 典型模板 |
|------|----------|
| vote (投票) | 年度最佳员工评选、活动时间投票 |
| survey (问卷) | 活动满意度调查、产品反馈问卷 |
| rating (评分) | 服务评价、产品打分 |
| feedback (反馈) | 意见收集、问题反馈 |
| collection (信息收集) | 活动报名、信息登记 |

### 9.3 推荐模板数量

- 每个分类：5-10 个模板
- 特色模板：总计 3-5 个
- 总计：20-30 个模板为宜

---

## 10. 未来扩展

### 10.1 计划功能

- [ ] 模板预览图自动生成
- [ ] 模板导入/导出（JSON 格式）
- [ ] 模板分享功能
- [ ] 用户自定义模板
- [ ] 模板评分和评论
- [ ] AI 智能推荐模板

### 10.2 性能优化

- [ ] 模板列表缓存
- [ ] 预览图 CDN 加速
- [ ] 按需加载表单数据

---

*本文档由 Claude AI 协助创建*
