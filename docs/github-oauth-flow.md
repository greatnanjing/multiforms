# GitHub OAuth ç™»å½•å®Œæ•´æµç¨‹å›¾

## æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·æµè§ˆå™¨
    participant F as MultiForms å‰ç«¯
    participant S as Supabase åç«¯
    participant G as GitHub

    Note over U,F: æ­¥éª¤ 1-3: å‘èµ·æˆæƒï¼ˆå‰ç«¯ï¼Œæ— éœ€ Client Secretï¼‰
    U->>F: ç‚¹å‡» "GitHub ç™»å½•" æŒ‰é’®
    F->>S: supabase.auth.signInWithOAuth({ provider: 'github' })
    S-->>U: 302 é‡å®šå‘åˆ° GitHub<br/>(URL åŒ…å« client_id)
    U->>G: è®¿é—® GitHub æˆæƒé¡µé¢
    G-->>U: æ˜¾ç¤ºæˆæƒé¡µé¢<br/>"MultiForms æƒ³è¦è®¿é—®ä½ çš„è´¦å·"
    U->>G: ç‚¹å‡» "æˆæƒ"

    Note over G,S: æ­¥éª¤ 4-5: GitHub è¿”å› Authorization Code
    G->>G: ç”Ÿæˆ Authorization Code<br/>(æœ‰æ•ˆæœŸ 10 åˆ†é’Ÿï¼Œä¸€æ¬¡æ€§)
    G-->>S: 302 é‡å®šå‘åˆ° Supabase<br/>?code=xxx&state=yyy

    Note over S,G: æ­¥éª¤ 6-8: æ¢å– Access Tokenï¼ˆğŸ”’ è¿™é‡Œä½¿ç”¨ Client Secretï¼‰
    S->>G: POST /login/oauth/access_token<br/>{<br/>  "client_id": "Iv1.xxx",<br/>  "client_secret": "ğŸ”’GH_SECRET_xxx",<br/>  "code": "xxx"<br/>}

    Note over G: GitHub éªŒè¯
    G->>G: âœ“ client_id å­˜åœ¨ï¼Ÿ<br/>âœ“ client_secret åŒ¹é…ï¼Ÿ<br/>âœ“ code æœ‰æ•ˆï¼ˆæœªè¿‡æœŸã€æœªä½¿ç”¨ï¼‰ï¼Ÿ

    G-->>S: 200 OK<br/>{ "access_token": "gho_xxx", ... }

    Note over S,G: æ­¥éª¤ 9: è·å–ç”¨æˆ·ä¿¡æ¯
    S->>G: GET /user<br/>Authorization: Bearer gho_xxx
    G-->>S: 200 OK<br/>{ "id": 123, "login": "username", "email": "..." }

    Note over S: æ­¥éª¤ 10-12: åˆ›å»ºä¼šè¯ã€è®¾ç½® Cookieã€é‡å®šå‘
    S->>S: åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•<br/>ç”Ÿæˆ Supabase Session JWT
    S->>S: è®¾ç½® Cookie (HttpOnly, Secure)
    S-->>U: 302 é‡å®šå‘åˆ° /auth/callback<br/>å¸¦ä¸Š Set-Cookie header

    Note over U,F: æ­¥éª¤ 13-14: å®Œæˆç™»å½•
    U->>F: æµè§ˆå™¨è‡ªåŠ¨è®¿é—® /auth/callback
    F->>S: exchangeCodeForSession(code)
    S-->>F: 200 OK (Session å·²é€šè¿‡ Cookie ä¼ é€’)
    Note over U: æ­¤æ—¶æµè§ˆå™¨å·²å­˜å‚¨ Supabase Session Cookie
    F->>F: é‡å®šå‘åˆ° /dashboard
```

## å…³é”®ç‚¹æ€»ç»“

| æ­¥éª¤ | Client Secret | è¯´æ˜ |
|------|---------------|------|
| 1-3: å‘èµ·æˆæƒ | âŒ ä¸éœ€è¦ | å‰ç«¯è¯·æ±‚ï¼Œåªéœ€ client_idï¼ˆå…¬å¼€ï¼‰ |
| 4-5: è¿”å› code | âŒ ä¸éœ€è¦ | GitHub â†’ Supabase é‡å®šå‘ |
| **6-8: æ¢ token** | **âœ… å¿…é¡»** | **Supabase â†’ GitHub æœåŠ¡å™¨é€šä¿¡** |
| 9-11: è·å–ç”¨æˆ·ä¿¡æ¯ | âŒ ä¸éœ€è¦ | ç”¨ access_token è°ƒç”¨ API |
| 12-13: å®Œæˆç™»å½• | âŒ ä¸éœ€è¦ | é‡å®šå‘å›åº”ç”¨ |

## å®‰å…¨æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ï¼ˆç”¨æˆ·æµè§ˆå™¨ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  supabase.auth.signInWithOAuth({ provider: 'github' })  â”‚   â”‚
â”‚  â”‚  â†“                                                      â”‚   â”‚
â”‚  â”‚  å‘é€åˆ° GitHub çš„ URL:                                   â”‚   â”‚
â”‚  â”‚  https://github.com/login/oauth/authorize              â”‚   â”‚
â”‚  â”‚    ?client_id=Iv1.abc123          â† å…¬å¼€çš„ï¼Œå¯è§        â”‚   â”‚
â”‚  â”‚    &redirect_uri=https://xxx.supabase.co/...           â”‚   â”‚
â”‚  â”‚    &scope=read:user user:email                         â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  âŒ ä¸åŒ…å« client_secretï¼                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Supabase åç«¯æœåŠ¡å™¨                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  POST https://github.com/login/oauth/access_token      â”‚   â”‚
â”‚  â”‚  Content-Type: application/json                         â”‚   â”‚
â”‚  â”‚  {                                                     â”‚   â”‚
â”‚  â”‚    "client_id": "Iv1.abc123",       â† å…¬å¼€çš„            â”‚   â”‚
â”‚  â”‚    "client_secret": "ğŸ”’GH_SECRET_xyz" â† ğŸ”’ ç§˜å¯†åœ¨è¿™é‡Œï¼ â”‚   â”‚
â”‚  â”‚    "code": "a1b2c3d4..."                             â”‚   â”‚
â”‚  â”‚  }                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â”‚  âœ“ Client Secret å­˜å‚¨åœ¨ Supabase æœåŠ¡å™¨ï¼Œç”¨æˆ·æ— æ³•è®¿é—®           â”‚
â”‚  âœ“ åªæœ‰æœåŠ¡å™¨é—´çš„é€šä¿¡æ‰ä½¿ç”¨ Client Secret                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å®‰å…¨ï¼Ÿ

1. **å‰ç«¯ä»£ç æ˜¯å…¬å¼€çš„** - ç”¨æˆ·æŒ‰ F12 å°±èƒ½çœ‹åˆ°
2. **Client Secret ä¸èƒ½æ”¾å‰ç«¯** - å¦åˆ™ä»»ä½•äººéƒ½èƒ½å†’å……ä½ çš„åº”ç”¨
3. **ä¸¤æ¬¡è¯·æ±‚åˆ†ç¦»** - ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆæˆæƒï¼‰åœ¨å‰ç«¯ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆæ¢ tokenï¼‰åœ¨åç«¯
4. **Code åªèƒ½ä½¿ç”¨ä¸€æ¬¡** - å³ä½¿æœ‰äººæˆªè· codeï¼Œç”¨å®Œå°±å¤±æ•ˆäº†
5. **Code çŸ­æœŸæœ‰æ•ˆ** - é€šå¸¸ 10 åˆ†é’Ÿå†…è¿‡æœŸ
6. **Redirect URI éªŒè¯** - Code åªä¼šå‘åˆ°ä½ æ³¨å†Œçš„å›è°ƒåœ°å€

---

## Token æµå‘è¯¦è§£

### å‰ç«¯æ‹¿åˆ°çš„æ˜¯ä»€ä¹ˆï¼Ÿ

å‰ç«¯é€šè¿‡ `supabase.auth.getSession()` æ‹¿åˆ°çš„æ˜¯ **Supabase è‡ªå·±çš„ Session JWT**ï¼Œ**ä¸æ˜¯** GitHub çš„ Access Tokenï¼š

```typescript
// å‰ç«¯è·å–åˆ°çš„ session
{
  access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // Supabase JWT
  user: {
    id: "xxx",
    email: "user@example.com",
    user_metadata: {
      name: "GitHubç”¨æˆ·å",
      avatar_url: "https://github.com/..." // GitHub å¤´åƒ
    }
  }
}
```

### Token å­˜å‚¨ä½ç½®å¯¹æ¯”

| Token | å­˜å‚¨ä½ç½® | è°èƒ½è®¿é—® | ç”¨é€” | ç”Ÿå‘½å‘¨æœŸ |
|-------|---------|---------|------|---------|
| **GitHub Access Token** | Supabase åç«¯ | âŒ å‰ç«¯æ— æ³•è®¿é—® | è·å– GitHub ç”¨æˆ·ä¿¡æ¯ | GitHub æœåŠ¡å™¨ç®¡ç† |
| **Supabase Session JWT** | æµè§ˆå™¨ Cookie | âœ… å‰ç«¯å¯è®¿é—® | è°ƒç”¨ä½ çš„åº”ç”¨ API | ç”±ä½ çš„åº”ç”¨æ§åˆ¶ |

### ä¸ºä»€ä¹ˆä¸æŠŠ GitHub Token ç»™å‰ç«¯ï¼Ÿ

```
âŒ ä¸å®‰å…¨çš„åšæ³•ï¼š
GitHub Access Token â†’ å‰ç«¯
â†’ ç”¨æˆ·æŒ‰ F12 å°±èƒ½çœ‹åˆ°
â†’ å¯ä»¥ç”¨è¿™ä¸ª token è®¿é—®ç”¨æˆ·çš„æ‰€æœ‰ GitHub æ•°æ®
â†’ å¯ä»¥ä¿®æ”¹ç”¨æˆ·çš„ GitHub ä»“åº“ã€ä»£ç ç­‰

âœ… å®‰å…¨çš„åšæ³•ï¼š
GitHub Access Token â†’ Supabase åç«¯
â†’ åç«¯ç”¨ token è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
â†’ ç„¶åç«‹å³ä¸¢å¼ƒæˆ–å®‰å…¨å­˜å‚¨
â†’ å‰ç«¯åªæ‹¿åˆ° Supabase Session
â†’ Session åªèƒ½è®¿é—®ä½ çš„åº”ç”¨ï¼Œä¸èƒ½è®¿é—® GitHub
```

### å®Œæ•´çš„ Token è½¬æ¢é“¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ gho_xxx (GitHub Access Token)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Backend   â”‚
â”‚  - è·å–ç”¨æˆ·ä¿¡æ¯      â”‚
â”‚  - åˆ›å»º/æ›´æ–°ç”¨æˆ·     â”‚
â”‚  - ç”Ÿæˆè‡ªå·±çš„ JWT   â”‚ â† è¿™æ˜¯å‰ç«¯æ‹¿åˆ°çš„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ eyJhbGci... (Supabase Session)
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å‰ç«¯æµè§ˆå™¨  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ€»ç»“

- **GitHub Access Token** = å¼€é—¨çš„é’¥åŒ™ï¼Œç”± Supabase åç«¯ä¿ç®¡ï¼Œç”¨æ¥ä¸€æ¬¡æ€§è·å–ç”¨æˆ·ä¿¡æ¯
- **Supabase Session** = å…¥åœºåˆ¸ï¼Œå‘ç»™å‰ç«¯ï¼Œç”¨æ¥åœ¨ä½ çš„åº”ç”¨å†…è¯æ˜èº«ä»½
- å‰ç«¯æ°¸è¿œä¸éœ€è¦ï¼ˆä¹Ÿä¸åº”è¯¥ï¼‰çŸ¥é“ GitHub Access Token
