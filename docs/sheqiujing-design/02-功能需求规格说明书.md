# 佘秋婧相亲平台 - 功能需求规格说明书 (SRS)

## 目录
1. [用户注册与实名认证系统](#1-用户注册与实名认证系统)
2. [个人资料管理系统](#2-个人资料管理系统)
3. [智能匹配算法系统](#3-智能匹配算法系统)
4. [互动功能系统](#4-互动功能系统)
5. [线下活动预约系统](#5-线下活动预约系统)

---

## 1. 用户注册与实名认证系统

### 1.1 手机号注册与验证模块

#### 1.1.1 功能描述
实现基于手机号的用户注册流程，支持短信验证码验证，确保每个手机号只能注册一个账号。

#### 1.1.2 业务流程

**注册流程图：**
```
开始 → 输入手机号 → 格式验证 → 检测是否已注册
    ↓未注册              ↓已注册
发送验证码 ←──────────── 提示登录
    ↓
输入验证码 → 验证有效性 → 验证通过?
    ↓验证通过            ↓验证失败
创建账号 ←──────────── 重试/重新发送
    ↓
设置密码 → 密码强度检测 → 强度合格?
    ↓合格                ↓不合格
完成注册 ←──────────── 提示修改
```

#### 1.1.3 详细功能点

**1. 手机号输入与验证**
- **字段要求：**
  - 手机号：11位中国大陆手机号，支持130-139、150-159、180-189、198、199等号段
  - 国际手机号：支持+86开头的国际格式，自动去除空格和分隔符

- **前端验证规则：**
  ```javascript
  const phoneRegex = /^1[3-9]\d{9}$/;
  const validationRules = {
    required: true,
    pattern: phoneRegex,
    minLength: 11,
    maxLength: 11,
    errorMessages: {
      required: '请输入手机号码',
      pattern: '请输入正确的手机号码格式',
      minLength: '手机号长度不足11位',
      maxLength: '手机号长度超过11位'
    }
  };
  ```

- **后端验证流程：**
  1. 接收手机号参数
  2. 正则表达式格式校验
  3. 查询数据库检查是否已注册
  4. 检查该手机号是否被锁定（24小时内发送超过5次）
  5. 调用短信服务商API发送验证码
  6. Redis存储验证码，TTL=5分钟
  7. 记录发送日志

**2. 短信验证码机制**
- **验证码生成规则：**
  ```java
  public String generateVerificationCode() {
      // 6位纯数字验证码
      Random random = new Random();
      StringBuilder code = new StringBuilder();
      for (int i = 0; i < 6; i++) {
          code.append(random.nextInt(10));
      }
      return code.toString();
  }
  ```

- **发送频率限制：**
  ```java
  @RateLimiter(name = "smsCode", key = "#phone", 
               limit = 5, period = 24, unit = TimeUnit.HOURS)
  public void sendVerificationCode(String phone) {
      // 每个手机号24小时内最多发送5次验证码
      // 同一验证码5分钟内有效
      // 发送间隔至少60秒
  }
  ```

- **验证码存储结构（Redis）：**
  ```
  Key: sms:code:{phone}
  Value: {code}
  TTL: 300秒（5分钟）
  
  Key: sms:count:{phone}
  Value: {count}
  TTL: 86400秒（24小时）
  ```

- **短信模板：**
  ```
  【缘聚佘秋婧】您的验证码是 {code}，5分钟内有效。请勿将验证码告知他人。
  ```

**3. 验证码验证流程**
- **验证逻辑：**
  ```java
  public VerificationResult verifyCode(String phone, String code) {
      // 1. 从Redis获取存储的验证码
      String storedCode = redisTemplate.opsForValue().get("sms:code:" + phone);
      
      // 2. 验证码不存在或已过期
      if (storedCode == null) {
          return VerificationResult.EXPIRED;
      }
      
      // 3. 验证码不匹配
      if (!storedCode.equals(code)) {
          // 记录失败次数
          incrementFailCount(phone);
          return VerificationResult.INVALID;
      }
      
      // 4. 验证成功，删除验证码
      redisTemplate.delete("sms:code:" + phone);
      clearFailCount(phone);
      
      return VerificationResult.SUCCESS;
  }
  ```

- **失败次数限制：**
  - 连续输错5次，锁定该手机号2小时
  - 锁定期间无法发送验证码

**4. 密码设置与强度检测**
- **密码要求：**
  - 长度：8-20位
  - 必须包含：大写字母、小写字母、数字
  - 可选包含：特殊字符（!@#$%^&*等）
  - 不能包含：连续3位以上相同字符、手机号、常见弱密码

- **密码强度评分算法：**
  ```java
  public int calculatePasswordStrength(String password) {
      int score = 0;
      
      // 基础长度分
      if (password.length() >= 8) score += 10;
      if (password.length() >= 12) score += 10;
      if (password.length() >= 16) score += 10;
      
      // 字符类型分
      if (password.matches(".*[a-z].*")) score += 10; // 小写字母
      if (password.matches(".*[A-Z].*")) score += 10; // 大写字母
      if (password.matches(".*\d.*")) score += 10;     // 数字
      if (password.matches(".*[!@#$%^&*].*")) score += 15; // 特殊字符
      
      // 复杂度分
      if (password.matches("^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$")) score += 15;
      if (password.matches("^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).+$")) score += 20;
      
      // 扣分项
      if (password.matches("(.)\\1{2,}")) score -= 10; // 连续相同字符
      if (isCommonPassword(password)) score -= 20;      // 常见弱密码
      
      return Math.max(0, Math.min(100, score));
  }
  ```

- **密码强度等级：**
  - 0-40分：弱（红色提示）
  - 41-70分：中等（黄色提示）
  - 71-100分：强（绿色提示）

- **密码加密存储：**
  ```java
  // 使用BCrypt加密，工作因子12
  BCryptPasswordEncoder encoder = new BCryptPasswordEncoder(12);
  String encodedPassword = encoder.encode(plainPassword);
  ```

### 1.2 身份证实名认证模块

#### 1.2.1 功能描述
对接公安部身份核验接口，验证用户真实身份，确保平台用户真实性。

#### 1.2.2 认证流程
```
用户提交身份信息 → 前端初步验证 → 后端格式校验
        ↓
调用公安核验接口 → 核验结果处理
        ↓
人脸比对验证 → 人工复核（抽查）
        ↓
认证结果通知 → 更新用户认证状态
```

#### 1.2.3 详细功能点

**1. 身份证信息录入**
- **必填字段：**
  | 字段名 | 类型 | 约束 | 说明 |
  |--------|------|------|------|
  | realName | String | 2-20字符，中文 | 真实姓名 |
  | idCardNumber | String | 18位 | 身份证号码 |
  | idCardFront | File | JPG/PNG, <5MB | 身份证正面照 |
  | idCardBack | File | JPG/PNG, <5MB | 身份证反面照 |
  | facePhoto | File | JPG/PNG, <5MB | 手持身份证照片 |

- **身份证格式验证：**
  ```java
  public boolean validateIdCard(String idCard) {
      // 18位身份证格式
      String regex = "^[1-9]\\d{5}(18|19|20)\\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$";
      if (!idCard.matches(regex)) {
          return false;
      }
      
      // 校验码验证
      int[] weights = {7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2};
      char[] checkCodes = {'1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'};
      
      int sum = 0;
      for (int i = 0; i < 17; i++) {
          sum += (idCard.charAt(i) - '0') * weights[i];
      }
      
      char checkCode = checkCodes[sum % 11];
      return Character.toUpperCase(idCard.charAt(17)) == checkCode;
  }
  ```

- **姓名验证：**
  - 仅允许中文姓名（包括少数民族姓名中的·）
  - 长度2-20个字符
  - 不允许数字、特殊字符
  - 常见虚假姓名过滤（如"测试用户"、"张三"等）

**2. 身份证OCR识别**
- **技术方案：** 阿里云/腾讯云OCR服务
- **识别准确率：** >98%
- **处理流程：**
  1. 用户上传身份证照片
  2. 前端压缩图片（最大宽度2000px）
  3. 后端调用OCR API识别文字
  4. 提取姓名、身份证号、有效期等信息
  5. 用户确认或修正识别结果
  6. 保存高清原图到OSS

- **OCR识别结果存储：**
  ```json
  {
    "idCardOcrResult": {
      "name": "佘秋婧",
      "idCardNumber": "310101199501011234",
      "gender": "女",
      "birthDate": "1995-01-01",
      "address": "上海市黄浦区...",
      "issuingAuthority": "上海市公安局黄浦分局",
      "validityPeriod": "2015.01.01-2035.01.01",
      "confidence": 0.98,
      "extractedAt": "2026-02-05T10:30:00Z"
    }
  }
  ```

**3. 公安身份核验**
- **对接接口：** 阿里云/腾讯云/公安部身份核验API
- **核验流程：**
  ```java
  public VerificationResult verifyIdentity(String name, String idCard) {
      // 构建请求参数
      IdentityVerifyRequest request = IdentityVerifyRequest.builder()
          .realName(name)
          .idCardNumber(idCard)
          .build();
      
      // 调用第三方核验接口
      IdentityVerifyResponse response = idVerifyClient.verify(request);
      
      // 处理核验结果
      switch (response.getResultCode()) {
          case "00": // 一致
              return VerificationResult.CONSISTENT;
          case "01": // 不一致
              return VerificationResult.INCONSISTENT;
          case "02": // 库中无此号
              return VerificationResult.NOT_FOUND;
          case "03": // 验证失败
              return VerificationResult.VERIFY_FAILED;
          default:
              return VerificationResult.SYSTEM_ERROR;
      }
  }
  ```

- **核验结果处理：**
  | 结果代码 | 含义 | 处理方式 |
  |----------|------|----------|
  | 00 | 姓名身份证号一致 | 通过，进入下一步 |
  | 01 | 姓名身份证号不一致 | 拒绝，提示重新输入 |
  | 02 | 库中无此号 | 拒绝，提示检查信息 |
  | 03 | 验证失败 | 重试3次后人工审核 |

**4. 人脸比对验证**
- **活体检测：** 防止使用照片、视频攻击
  - 动作活体：随机动作组合（眨眼、张嘴、摇头等）
  - 静默活体：基于深度学习的活体检测
  
- **人脸比对流程：**
  1. 用户拍摄实时照片（前置摄像头）
  2. 提取身份证照片中的人脸特征
  3. 对比两张照片的相似度
  4. 相似度阈值：>75%为同一人

- **比对结果存储：**
  ```json
  {
    "faceVerification": {
      "similarity": 87.5,
      "isMatch": true,
      "livenessScore": 98.2,
      "isLive": true,
      "verifiedAt": "2026-02-05T10:35:00Z",
      "verifyPhotoUrl": "https://oss.xxx.com/verify/xxx.jpg"
    }
  }
  ```

**5. 人工复核机制**
- **复核触发条件：**
  - 人脸比对相似度在70%-75%之间
  - 身份证照片模糊或不清晰
  - 系统检测到可疑行为（短时间内多次认证）
  - 随机抽查（10%比例）

- **人工审核流程：**
  1. 认证信息进入待审核队列
  2. 审核人员查看：身份证照片、人脸比对结果、用户行为记录
  3. 审核人员决策：通过/拒绝/要求补充材料
  4. 审核时限：工作日24小时内完成
  5. 审核结果通知用户（短信+APP推送）

- **审核记录：**
  ```sql
  CREATE TABLE identity_audit_logs (
      id BIGINT PRIMARY KEY AUTO_INCREMENT,
      user_id BIGINT NOT NULL,
      auditor_id BIGINT,
      audit_status ENUM('PENDING', 'PASSED', 'REJECTED', 'SUPPLEMENT'),
      audit_remark VARCHAR(500),
      id_card_photo_front VARCHAR(500),
      id_card_photo_back VARCHAR(500),
      face_photo VARCHAR(500),
      similarity_score DECIMAL(5,2),
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      INDEX idx_user_id (user_id),
      INDEX idx_status (audit_status)
  );
  ```

### 1.3 账号安全机制

#### 1.3.1 密码安全策略

**1. 密码强度强制要求**
- 新注册必须设置强密码（强度分≥60）
- 定期（90天）提示用户修改密码
- 历史密码不能重复使用（最近5次）

**2. 登录异常检测**
- **检测维度：**
  - 异地登录检测（IP地理位置变化）
  - 设备变更检测（新设备登录）
  - 登录时间异常（深夜登录）
  - 登录频率异常（短时间内多次失败）

- **风险等级评估：**
  ```java
  public RiskLevel assessLoginRisk(LoginContext context) {
      int riskScore = 0;
      
      // 异地登录 +30分
      if (!isSameCity(context.getIp(), context.getLastLoginIp())) {
          riskScore += 30;
      }
      
      // 新设备 +20分
      if (!context.isKnownDevice()) {
          riskScore += 20;
      }
      
      // 深夜登录 +10分 (23:00-05:00)
      if (isLateNight(context.getLoginTime())) {
          riskScore += 10;
      }
      
      // 连续失败 +5分/次
      int failCount = getRecentFailCount(context.getUserId(), Duration.ofMinutes(30));
      riskScore += failCount * 5;
      
      // 风险等级判定
      if (riskScore >= 60) return RiskLevel.HIGH;
      if (riskScore >= 30) return RiskLevel.MEDIUM;
      return RiskLevel.LOW;
  }
  ```

- **风险处置措施：**
  | 风险等级 | 处置措施 |
  |----------|----------|
  | LOW | 正常登录 |
  | MEDIUM | 发送登录提醒通知，记录日志 |
  | HIGH | 要求二次验证（短信/邮箱），发送安全提醒 |

**3. 账号锁定机制**
- **触发条件：**
  - 连续5次登录失败，锁定30分钟
  - 连续10次登录失败，锁定24小时
  - 检测到暴力破解行为，永久锁定

- **锁定实现：**
  ```java
  @Service
  public class AccountLockService {
      
      public void recordLoginFailure(Long userId) {
          String key = "login:fail:" + userId;
          Long count = redisTemplate.opsForValue().increment(key);
          
          if (count == 1) {
              // 首次失败，设置30分钟过期
              redisTemplate.expire(key, 30, TimeUnit.MINUTES);
          }
          
          // 连续5次失败，锁定30分钟
          if (count >= 5) {
              lockAccount(userId, 30, TimeUnit.MINUTES);
          }
          
          // 连续10次失败，锁定24小时
          if (count >= 10) {
              lockAccount(userId, 24, TimeUnit.HOURS);
          }
      }
      
      public boolean isAccountLocked(Long userId) {
          String key = "account:locked:" + userId;
          return redisTemplate.hasKey(key);
      }
      
      private void lockAccount(Long userId, long duration, TimeUnit unit) {
          String key = "account:locked:" + userId;
          redisTemplate.opsForValue().set(key, "LOCKED", duration, unit);
          
          // 发送账号锁定通知
          sendLockNotification(userId, duration, unit);
      }
  }
  ```

**4. 会话安全管理**
- **Token策略：** JWT + Refresh Token双令牌机制
- **Token有效期：**
  - Access Token: 2小时
  - Refresh Token: 7天
- **多设备登录控制：** 最多同时在线3个设备
- **会话过期处理：** 自动刷新或重新登录

---

## 2. 个人资料管理系统

### 2.1 基础信息管理

#### 2.1.1 字段设计

**用户信息表 (user_profiles)：**
```sql
CREATE TABLE user_profiles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL UNIQUE,
    
    -- 基础信息
    nickname VARCHAR(50),
    gender ENUM('MALE', 'FEMALE'),
    birth_date DATE,
    age INT GENERATED ALWAYS AS (TIMESTAMPDIFF(YEAR, birth_date, CURDATE())) STORED,
    height_cm INT, -- 身高(厘米)
    weight_kg DECIMAL(4,1), -- 体重(公斤)
    blood_type ENUM('A', 'B', 'AB', 'O'),
    
    -- 家乡信息
    hometown_province VARCHAR(50),
    hometown_city VARCHAR(50),
    hometown_district VARCHAR(50),
    
    -- 现居地信息
    current_province VARCHAR(50),
    current_city VARCHAR(50),
    current_district VARCHAR(50),
    current_address VARCHAR(200),
    
    -- 教育信息
    education_level ENUM('HIGH_SCHOOL', 'COLLEGE', 'BACHELOR', 'MASTER', 'PHD', 'POSTDOC'),
    school_name VARCHAR(100),
    major VARCHAR(100),
    graduation_year YEAR,
    
    -- 职业信息
    occupation_type ENUM('TECH', 'FINANCE', 'EDUCATION', 'MEDICAL', 'GOVERNMENT', 
                        'ENTERPRISE', 'SELF_EMPLOYED', 'FREELANCE', 'OTHER'),
    job_title VARCHAR(100),
    company_name VARCHAR(100),
    company_nature ENUM('STATE_OWNED', 'FOREIGN', 'PRIVATE', 'JOINT_VENTURE', 'STARTUP'),
    work_experience_years INT,
    
    -- 收入信息
    annual_income_range ENUM('UNDER_10W', '10W_20W', '20W_30W', '30W_50W', 
                            '50W_100W', '100W_200W', 'ABOVE_200W'),
    has_house ENUM('NO', 'YES_WITH_MORTGAGE', 'YES_WITHOUT_MORTGAGE'),
    has_car ENUM('NO', 'YES'),
    
    -- 婚姻状况
    marital_status ENUM('SINGLE', 'DIVORCED', 'WIDOWED'),
    has_children ENUM('NO', 'YES_WITH_ME', 'YES_WITHOUT_ME'),
    
    -- 个人介绍
    self_introduction TEXT,
    mate_requirements TEXT,
    
    -- 兴趣爱好(多选，逗号分隔)
    hobbies VARCHAR(500),
    
    -- 认证状态
    real_name_verified BOOLEAN DEFAULT FALSE,
    education_verified BOOLEAN DEFAULT FALSE,
    income_verified BOOLEAN DEFAULT FALSE,
    house_verified BOOLEAN DEFAULT FALSE,
    car_verified BOOLEAN DEFAULT FALSE,
    
    -- 账户状态
    profile_completion_rate INT DEFAULT 0,
    is_profile_public BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_gender_age (gender, age),
    INDEX idx_location (current_city, current_district),
    INDEX idx_education (education_level),
    INDEX idx_marital (marital_status),
    INDEX idx_income (annual_income_range),
    INDEX idx_verified (real_name_verified)
);
```

#### 2.1.2 学历层次定义

| 代码 | 显示名称 | 层次数值 | 匹配范围 |
|------|----------|----------|----------|
| HIGH_SCHOOL | 高中/中专 | 10 | ±1 |
| COLLEGE | 大专 | 12 | ±1 |
| BACHELOR | 本科 | 16 | ±2 |
| MASTER | 硕士 | 18 | ±2 |
| PHD | 博士 | 20 | ±2 |
| POSTDOC | 博士后 | 22 | ±2 |

#### 2.1.3 收入区间定义

| 代码 | 显示名称 | 收入范围 | 匹配阈值 |
|------|----------|----------|----------|
| UNDER_10W | 10万以下 | <10万 | 向下兼容 |
| 10W_20W | 10-20万 | 10-20万 | 70% |
| 20W_30W | 20-30万 | 20-30万 | 70% |
| 30W_50W | 30-50万 | 30-50万 | 70% |
| 50W_100W | 50-100万 | 50-100万 | 70% |
| 100W_200W | 100-200万 | 100-200万 | 70% |
| ABOVE_200W | 200万以上 | >200万 | 向上兼容 |

### 2.2 照片管理系统

#### 2.2.1 功能要求
- **上传限制：**
  - 格式：JPG、JPEG、PNG
  - 单张大小：最大5MB
  - 数量限制：最多6张
  - 分辨率：建议600x800以上

- **图片处理流程：**
  1. 前端压缩（图片最大宽度1920px）
  2. 上传至OSS
  3. 后端生成缩略图（200x200px）
  4. AI审核（涉黄、涉暴、涉政检测）
  5. 人工抽查（10%比例）
  6. 审核通过后显示

- **图片裁剪功能：**
  - 支持自由裁剪（1:1, 3:4, 4:3比例）
  - 支持旋转
  - 支持亮度/对比度调整

#### 2.2.2 数据表设计
```sql
CREATE TABLE user_photos (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    photo_url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500),
    photo_type ENUM('AVATAR', 'LIFE', 'ALBUM'),
    display_order INT DEFAULT 0,
    is_primary BOOLEAN DEFAULT FALSE,
    ai_audit_status ENUM('PENDING', 'PASSED', 'REJECTED') DEFAULT 'PENDING',
    ai_audit_score DECIMAL(5,2),
    ai_audit_reason VARCHAR(200),
    human_audit_status ENUM('PENDING', 'PASSED', 'REJECTED') DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_photo_type (photo_type)
);
```

### 2.3 视频介绍系统

#### 2.3.1 功能要求
- **时长限制：** 30-60秒
- **格式：** MP4、MOV
- **分辨率：** 720p及以上
- **文件大小：** 最大50MB
- **内容审核：** AI+人工双重审核

#### 2.3.2 视频处理流程
1. 用户录制/上传视频
2. 前端压缩转码（H.264编码）
3. 上传到视频云存储
4. 提取视频封面（第1帧或用户选择）
5. AI内容审核（语音识别、图像识别）
6. 人工审核
7. 生成多码率播放链接（360p/480p/720p）
8. 审核通过后展示

#### 2.3.3 数据表设计
```sql
CREATE TABLE user_videos (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    video_url VARCHAR(500) NOT NULL,
    cover_image_url VARCHAR(500),
    duration_seconds INT, -- 视频时长(秒)
    file_size_mb DECIMAL(6,2),
    resolution VARCHAR(20), -- 如 "1280x720"
    transcoded_urls JSON, -- 多码率链接
    ai_audit_status ENUM('PENDING', 'PASSED', 'REJECTED') DEFAULT 'PENDING',
    human_audit_status ENUM('PENDING', 'PASSED', 'REJECTED') DEFAULT 'PENDING',
    view_count INT DEFAULT 0,
    like_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id)
);
```

### 2.4 兴趣爱好标签系统

#### 2.4.1 标签分类

**运动健身类：**
- 健身、瑜伽、跑步、游泳、羽毛球、乒乓球、网球、篮球、足球、高尔夫、登山、骑行、滑雪、潜水

**文化艺术类：**
- 阅读、写作、绘画、书法、摄影、音乐、乐器、唱歌、跳舞、电影、戏剧、博物馆、艺术展览

**生活娱乐类：**
- 烹饪、烘焙、茶道、咖啡、品酒、旅游、露营、钓鱼、宠物、园艺、手工DIY、桌游、电竞

**社交活动类：**
- 聚会、K歌、桌游、剧本杀、密室逃脱、 volunteering、慈善公益

**学习成长类：**
- 外语学习、投资理财、职业技能、心理学、哲学、历史、科技

#### 2.4.2 标签管理
- 系统预设标签库（200+标签）
- 用户可自定义标签（需审核）
- 每人最多选择10个标签
- 标签权重计算（用于匹配算法）

---

## 3. 智能匹配算法系统

### 3.1 匹配维度设计

#### 3.1.1 核心匹配维度权重

| 匹配维度 | 权重 | 说明 |
|----------|------|------|
| 地理位置 | 25% | 同城优先，距离越近得分越高 |
| 年龄匹配 | 20% | 严格±5岁范围 |
| 学历匹配 | 15% | 学历相当或±1个层次 |
| 收入匹配 | 15% | 收入区间匹配度 |
| 婚姻状况 | 10% | 未婚配未婚，离异配离异/未婚 |
| 身高匹配 | 8% | 符合择偶身高要求 |
| 职业匹配 | 5% | 职业类型相关性 |
| 兴趣匹配 | 2% | 共同兴趣爱好 |

#### 3.1.2 匹配评分算法

```java
@Service
public class MatchingAlgorithmService {
    
    public MatchScore calculateMatchScore(UserProfile user, UserProfile candidate) {
        MatchScore score = new MatchScore();
        
        // 1. 地理位置匹配 (25%)
        double locationScore = calculateLocationScore(user, candidate);
        score.addDimension("location", locationScore, 0.25);
        
        // 2. 年龄匹配 (20%)
        double ageScore = calculateAgeScore(user, candidate);
        score.addDimension("age", ageScore, 0.20);
        
        // 3. 学历匹配 (15%)
        double educationScore = calculateEducationScore(user, candidate);
        score.addDimension("education", educationScore, 0.15);
        
        // 4. 收入匹配 (15%)
        double incomeScore = calculateIncomeScore(user, candidate);
        score.addDimension("income", incomeScore, 0.15);
        
        // 5. 婚姻状况匹配 (10%)
        double maritalScore = calculateMaritalScore(user, candidate);
        score.addDimension("marital", maritalScore, 0.10);
        
        // 6. 身高匹配 (8%)
        double heightScore = calculateHeightScore(user, candidate);
        score.addDimension("height", heightScore, 0.08);
        
        // 7. 职业匹配 (5%)
        double occupationScore = calculateOccupationScore(user, candidate);
        score.addDimension("occupation", occupationScore, 0.05);
        
        // 8. 兴趣匹配 (2%)
        double interestScore = calculateInterestScore(user, candidate);
        score.addDimension("interest", interestScore, 0.02);
        
        // 计算总分
        score.calculateTotal();
        
        return score;
    }
    
    // 地理位置评分
    private double calculateLocationScore(UserProfile user, UserProfile candidate) {
        // 同区：100分，同城不同区：80分，同省不同城：50分，不同省：0分
        if (user.getCurrentDistrict().equals(candidate.getCurrentDistrict())) {
            return 100;
        } else if (user.getCurrentCity().equals(candidate.getCurrentCity())) {
            return 80;
        } else if (user.getCurrentProvince().equals(candidate.getCurrentProvince())) {
            return 50;
        }
        return 0;
    }
    
    // 年龄评分
    private double calculateAgeScore(UserProfile user, UserProfile candidate) {
        int ageDiff = Math.abs(user.getAge() - candidate.getAge());
        
        // ±3岁：100分，±5岁：70分，超过5岁：0分
        if (ageDiff <= 3) {
            return 100;
        } else if (ageDiff <= 5) {
            return 70;
        }
        return 0;
    }
    
    // 学历评分
    private double calculateEducationScore(UserProfile user, UserProfile candidate) {
        int eduDiff = Math.abs(user.getEducationLevel().getValue() - candidate.getEducationLevel().getValue());
        
        // 同学历：100分，±1层次：80分，±2层次：50分
        if (eduDiff == 0) return 100;
        if (eduDiff == 1) return 80;
        if (eduDiff == 2) return 50;
        return 0;
    }
}
```

### 3.2 每日推荐机制

#### 3.2.1 推荐策略

**推荐池构建：**
1. 从数据库筛选符合基本条件（同城、异性、实名认证）的用户
2. 排除已匹配、已拉黑、已举报的用户
3. 计算每个候选用户与当前用户的匹配度分数
4. 按匹配度分数排序，取Top 50进入推荐池
5. 从推荐池随机选择8个用户（保证多样性）

**推荐刷新规则：**
- 每日8:00自动刷新
- 用户可手动刷新（每日限制3次，VIP用户5次）
- 刷新后，已查看的用户24小时内不再推荐

#### 3.2.2 推荐算法优化

**冷启动处理：**
- 新用户注册后，基于择偶要求推荐
- 完善资料越多，推荐越精准
- 首次推荐优先同城、同龄、同学历用户

**探索与利用平衡：**
- 70%：高匹配度用户（利用）
- 20%：中等匹配度用户（探索）
- 10%：新注册用户（曝光）

### 3.3 匹配记录管理

#### 3.3.1 匹配行为记录
```sql
CREATE TABLE match_interactions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    target_user_id BIGINT NOT NULL,
    interaction_type ENUM('LIKE', 'DISLIKE', 'SKIP', 'SUPER_LIKE'),
    match_score DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_user_target (user_id, target_user_id),
    INDEX idx_user_id (user_id),
    INDEX idx_target_user_id (target_user_id)
);
```

#### 3.3.2 双向匹配检测
```java
@Service
public class MatchingService {
    
    @Transactional
    public MatchResult processInteraction(Long userId, Long targetUserId, InteractionType type) {
        // 保存当前用户的互动
        saveInteraction(userId, targetUserId, type);
        
        // 检查是否为双向喜欢
        if (type == InteractionType.LIKE) {
            boolean mutualLike = checkMutualLike(userId, targetUserId);
            
            if (mutualLike) {
                // 创建匹配关系
                createMatch(userId, targetUserId);
                
                // 发送匹配成功通知
                sendMatchNotification(userId, targetUserId);
                
                return MatchResult.MATCHED;
            }
        }
        
        return MatchResult.RECORDED;
    }
    
    private boolean checkMutualLike(Long userId, Long targetUserId) {
        // 查询对方是否已喜欢当前用户
        MatchInteraction interaction = matchInteractionRepository
            .findByUserIdAndTargetUserId(targetUserId, userId);
        
        return interaction != null && interaction.getInteractionType() == InteractionType.LIKE;
    }
}
```

---

由于篇幅限制，我将继续创建后续章节。您需要我继续完成：
4. **互动功能系统** - 聊天、视频通话、联系方式解锁
5. **线下活动预约系统** - 活动管理、报名、保证金、签到
6. **数据库设计文档** - 完整ER图、所有表结构
7. **API接口文档** - 详细的RESTful API规范
8. **技术架构文档** - 前后端技术选型、部署方案

请告诉我您最希望先看到哪一部分的详细设计？