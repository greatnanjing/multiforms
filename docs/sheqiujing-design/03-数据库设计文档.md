# 佘秋婧相亲平台 - 数据库设计文档

## 1. 数据库架构概览

### 1.1 数据库选型
- **主数据库：** MySQL 8.0（InnoDB引擎）
- **缓存数据库：** Redis 7.0
- **搜索引擎：** Elasticsearch 8.x（用户搜索）
- **消息队列：** RabbitMQ（异步任务）
- **文件存储：** 阿里云OSS

### 1.2 分库分表策略
- **用户库（user_db）：** 按user_id取模分16个库，每库1024张表
- **消息库（message_db）：** 按会话ID哈希分8个库
- **匹配库（match_db）：** 单库单表（数据量可控）
- **日志库（log_db）：** 按时间分表，每月一张

### 1.3 命名规范
- **表名：** 小写，下划线分隔，业务前缀
  - 用户相关：user_*
  - 匹配相关：match_*
  - 消息相关：msg_*
  - 活动相关：event_*
- **字段名：** 小写，下划线分隔
- **索引名：** idx_表名_字段名
- **外键：** fk_表名_引用表名

---

## 2. 核心数据表设计

### 2.1 用户模块

#### 2.1.1 用户基础表 (users)
```sql
CREATE TABLE `users` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
    `phone` VARCHAR(20) NOT NULL COMMENT '手机号',
    `email` VARCHAR(100) COMMENT '邮箱',
    `password_hash` VARCHAR(255) NOT NULL COMMENT '密码哈希',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0-禁用 1-正常 2-锁定',
    `user_type` TINYINT NOT NULL DEFAULT 1 COMMENT '类型：1-普通 2-VIP 3-红娘',
    `registration_source` VARCHAR(20) COMMENT '注册来源：web/app/wechat',
    `last_login_at` DATETIME COMMENT '最后登录时间',
    `last_login_ip` VARCHAR(50) COMMENT '最后登录IP',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `deleted_at` DATETIME COMMENT '软删除时间',
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_phone` (`phone`),
    UNIQUE KEY `uk_email` (`email`),
    KEY `idx_status` (`status`),
    KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户基础表';
```

#### 2.1.2 用户资料表 (user_profiles)
```sql
CREATE TABLE `user_profiles` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    
    -- 基础信息
    `nickname` VARCHAR(50) COMMENT '昵称',
    `real_name` VARCHAR(50) COMMENT '真实姓名',
    `gender` TINYINT COMMENT '性别：1-男 2-女',
    `birth_date` DATE COMMENT '出生日期',
    `age` TINYINT UNSIGNED GENERATED ALWAYS AS (
        TIMESTAMPDIFF(YEAR, birth_date, CURDATE())
    ) STORED COMMENT '年龄',
    `height_cm` SMALLINT UNSIGNED COMMENT '身高(厘米)',
    `weight_kg` DECIMAL(4,1) COMMENT '体重(公斤)',
    `blood_type` ENUM('A','B','AB','O') COMMENT '血型',
    `zodiac` VARCHAR(20) GENERATED ALWAYS AS (
        CASE 
            WHEN MONTH(birth_date) = 1 AND DAY(birth_date) <= 19 THEN '摩羯座'
            WHEN MONTH(birth_date) = 1 OR (MONTH(birth_date) = 2 AND DAY(birth_date) <= 18) THEN '水瓶座'
            -- ... 其他星座
        END
    ) STORED COMMENT '星座',
    `chinese_zodiac` VARCHAR(10) GENERATED ALWAYS AS (
        CASE (YEAR(birth_date) % 12)
            WHEN 0 THEN '猴'
            WHEN 1 THEN '鸡'
            -- ... 其他生肖
        END
    ) STORED COMMENT '生肖',
    
    -- 家乡信息
    `hometown_country` VARCHAR(50) DEFAULT '中国' COMMENT '家乡国家',
    `hometown_province` VARCHAR(50) COMMENT '家乡省份',
    `hometown_city` VARCHAR(50) COMMENT '家乡城市',
    `hometown_district` VARCHAR(50) COMMENT '家乡区县',
    `hometown_longitude` DECIMAL(10,7) COMMENT '家乡经度',
    `hometown_latitude` DECIMAL(10,7) COMMENT '家乡纬度',
    
    -- 现居地信息
    `current_country` VARCHAR(50) DEFAULT '中国' COMMENT '现居国家',
    `current_province` VARCHAR(50) COMMENT '现居省份',
    `current_city` VARCHAR(50) COMMENT '现居城市',
    `current_district` VARCHAR(50) COMMENT '现居区县',
    `current_address` VARCHAR(200) COMMENT '详细地址',
    `current_longitude` DECIMAL(10,7) COMMENT '现居经度',
    `current_latitude` DECIMAL(10,7) COMMENT '现居纬度',
    `location_updated_at` DATETIME COMMENT '位置更新时间',
    
    -- 教育信息
    `education_level` TINYINT COMMENT '学历：1-高中 2-大专 3-本科 4-硕士 5-博士 6-博士后',
    `school_name` VARCHAR(100) COMMENT '学校名称',
    `school_type` VARCHAR(50) COMMENT '学校类型：985/211/普通一本/二本',
    `major` VARCHAR(100) COMMENT '专业',
    `graduation_year` YEAR COMMENT '毕业年份',
    
    -- 职业信息
    `occupation_type` SMALLINT COMMENT '职业类型代码',
    `occupation_name` VARCHAR(50) COMMENT '职业名称',
    `job_title` VARCHAR(100) COMMENT '职位/职称',
    `company_name` VARCHAR(100) COMMENT '公司名称',
    `company_nature` TINYINT COMMENT '公司性质：1-国企 2-外企 3-民企 4-合资 5-创业',
    `company_size` VARCHAR(20) COMMENT '公司规模',
    `work_experience_years` TINYINT COMMENT '工作年限',
    
    -- 经济状况
    `annual_income_min` INT UNSIGNED COMMENT '年收入下限(万元)',
    `annual_income_max` INT UNSIGNED COMMENT '年收入上限(万元)',
    `income_range_code` VARCHAR(20) COMMENT '收入区间代码',
    `has_house` TINYINT COMMENT '住房情况：0-无 1-有房有贷 2-有房无贷',
    `house_city` VARCHAR(50) COMMENT '房产所在城市',
    `has_car` TINYINT COMMENT '车辆情况：0-无 1-有',
    `car_brand` VARCHAR(50) COMMENT '车辆品牌',
    
    -- 婚姻状况
    `marital_status` TINYINT NOT NULL DEFAULT 1 COMMENT '婚姻状况：1-未婚 2-离异 3-丧偶',
    `has_children` TINYINT DEFAULT 0 COMMENT '是否有子女：0-无 1-有归自己 2-有归对方',
    `children_count` TINYINT DEFAULT 0 COMMENT '子女数量',
    `divorce_date` DATE COMMENT '离婚日期',
    `widowed_date` DATE COMMENT '丧偶日期',
    
    -- 个人介绍
    `self_introduction` TEXT COMMENT '自我介绍',
    `mate_requirements` TEXT COMMENT '择偶要求',
    `personality_tags` VARCHAR(500) COMMENT '性格标签JSON数组',
    `lifestyle_tags` VARCHAR(500) COMMENT '生活方式标签JSON数组',
    
    -- 家庭背景
    `family_structure` VARCHAR(50) COMMENT '家庭结构',
    `is_only_child` TINYINT COMMENT '是否独生子女：0-否 1-是',
    `parents_status` VARCHAR(100) COMMENT '父母情况',
    `siblings_count` TINYINT COMMENT '兄弟姐妹数量',
    
    -- 认证状态
    `real_name_verified` TINYINT DEFAULT 0 COMMENT '实名认证：0-未认证 1-待审核 2-已认证 3-拒绝',
    `real_name_verified_at` DATETIME COMMENT '实名认证时间',
    `education_verified` TINYINT DEFAULT 0 COMMENT '学历认证',
    `income_verified` TINYINT DEFAULT 0 COMMENT '收入认证',
    `house_verified` TINYINT DEFAULT 0 COMMENT '房产认证',
    `car_verified` TINYINT DEFAULT 0 COMMENT '车辆认证',
    
    -- 账户信息
    `avatar_url` VARCHAR(500) COMMENT '头像URL',
    `profile_photos` JSON COMMENT '照片数组JSON',
    `profile_video_url` VARCHAR(500) COMMENT '视频介绍URL',
    `profile_completion_rate` TINYINT UNSIGNED DEFAULT 0 COMMENT '资料完整度(%)',
    `is_profile_public` TINYINT DEFAULT 1 COMMENT '资料是否公开：0-否 1-是',
    `can_be_searched` TINYINT DEFAULT 1 COMMENT '是否可以被搜索：0-否 1-是',
    
    -- 会员信息
    `vip_level` TINYINT DEFAULT 0 COMMENT 'VIP等级：0-普通 1-银卡 2-金卡 3-钻卡',
    `vip_expire_at` DATETIME COMMENT 'VIP到期时间',
    `matchmaker_id` BIGINT COMMENT '专属红娘ID',
    
    -- 统计数据
    `view_count` INT UNSIGNED DEFAULT 0 COMMENT '被查看次数',
    `like_count` INT UNSIGNED DEFAULT 0 COMMENT '被喜欢次数',
    `match_count` INT UNSIGNED DEFAULT 0 COMMENT '匹配成功次数',
    
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_id` (`user_id`),
    KEY `idx_gender_age` (`gender`, `age`),
    KEY `idx_location` (`current_city`, `current_district`),
    KEY `idx_education` (`education_level`),
    KEY `idx_income` (`income_range_code`),
    KEY `idx_marital` (`marital_status`),
    KEY `idx_verified` (`real_name_verified`),
    KEY `idx_vip` (`vip_level`),
    KEY `idx_matchmaker` (`matchmaker_id`),
    KEY `idx_created_at` (`created_at`),
    
    CONSTRAINT `fk_profile_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户资料表';
```

#### 2.1.3 用户兴趣标签表 (user_interests)
```sql
CREATE TABLE `user_interests` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT UNSIGNED NOT NULL,
    `tag_id` INT UNSIGNED NOT NULL COMMENT '标签ID',
    `tag_name` VARCHAR(50) NOT NULL COMMENT '标签名称（冗余存储）',
    `tag_category` VARCHAR(50) COMMENT '标签分类',
    `weight` TINYINT DEFAULT 5 COMMENT '权重1-10',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_tag` (`user_id`, `tag_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_tag_id` (`tag_id`),
    
    CONSTRAINT `fk_interests_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户兴趣标签表';
```

#### 2.1.4 系统标签库表 (system_tags)
```sql
CREATE TABLE `system_tags` (
    `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `tag_name` VARCHAR(50) NOT NULL COMMENT '标签名称',
    `category` VARCHAR(50) NOT NULL COMMENT '分类：运动/艺术/生活/社交/学习',
    `sub_category` VARCHAR(50) COMMENT '子分类',
    `icon_url` VARCHAR(200) COMMENT '图标URL',
    `sort_order` INT DEFAULT 0 COMMENT '排序',
    `is_active` TINYINT DEFAULT 1 COMMENT '是否启用',
    `usage_count` INT UNSIGNED DEFAULT 0 COMMENT '使用次数',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_tag_name` (`tag_name`),
    KEY `idx_category` (`category`),
    KEY `idx_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统标签库';
```

### 2.2 认证模块

#### 2.2.1 实名认证表 (identity_verifications)
```sql
CREATE TABLE `identity_verifications` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT UNSIGNED NOT NULL,
    `real_name` VARCHAR(50) NOT NULL COMMENT '真实姓名',
    `id_card_number` VARCHAR(18) NOT NULL COMMENT '身份证号',
    `id_card_front_url` VARCHAR(500) COMMENT '身份证正面',
    `id_card_back_url` VARCHAR(500) COMMENT '身份证反面',
    `face_photo_url` VARCHAR(500) COMMENT '人脸照片',
    `face_comparison_score` DECIMAL(5,2) COMMENT '人脸比对分数',
    `ocr_result` JSON COMMENT 'OCR识别结果',
    `verify_status` TINYINT DEFAULT 0 COMMENT '状态：0-待提交 1-待审核 2-审核中 3-已通过 4-已拒绝',
    `verify_result` VARCHAR(50) COMMENT '核验结果：CONSISTENT/INCONSISTENT/NOT_FOUND',
    `reject_reason` VARCHAR(500) COMMENT '拒绝原因',
    `auditor_id` BIGINT COMMENT '审核人ID',
    `audited_at` DATETIME COMMENT '审核时间',
    `submit_count` TINYINT DEFAULT 1 COMMENT '提交次数',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_id` (`user_id`),
    KEY `idx_status` (`verify_status`),
    KEY `idx_auditor` (`auditor_id`),
    
    CONSTRAINT `fk_identity_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='实名认证表';
```

#### 2.2.2 学历认证表 (education_verifications)
```sql
CREATE TABLE `education_verifications` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT UNSIGNED NOT NULL,
    `education_level` TINYINT NOT NULL COMMENT '学历层次',
    `school_name` VARCHAR(100) NOT NULL,
    `major` VARCHAR(100),
    `graduation_year` YEAR,
    `degree_type` VARCHAR(50) COMMENT '学位类型',
    `certificate_photo_url` VARCHAR(500) COMMENT '学历证书照片',
    `verify_status` TINYINT DEFAULT 0,
    `verify_method` VARCHAR(50) COMMENT '认证方式：CHSI_MANUAL/AUTO',
    `reject_reason` VARCHAR(500),
    `auditor_id` BIGINT,
    `audited_at` DATETIME,
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_id` (`user_id`),
    KEY `idx_status` (`verify_status`),
    
    CONSTRAINT `fk_edu_verify_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='学历认证表';
```

### 2.3 匹配模块

#### 2.3.1 匹配交互表 (match_interactions)
```sql
CREATE TABLE `match_interactions` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    `target_user_id` BIGINT UNSIGNED NOT NULL COMMENT '目标用户ID',
    `interaction_type` TINYINT NOT NULL COMMENT '互动类型：1-喜欢 2-不喜欢 3-跳过 4-超级喜欢',
    `match_score` DECIMAL(5,2) COMMENT '匹配度分数',
    `is_mutual` TINYINT DEFAULT 0 COMMENT '是否双向：0-否 1-是',
    `mutual_at` DATETIME COMMENT '双向匹配时间',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_target` (`user_id`, `target_user_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_target_user_id` (`target_user_id`),
    KEY `idx_mutual` (`is_mutual`),
    KEY `idx_created_at` (`created_at`),
    
    CONSTRAINT `fk_interaction_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_interaction_target` FOREIGN KEY (`target_user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='匹配交互表';
```

#### 2.3.2 匹配关系表 (matches)
```sql
CREATE TABLE `matches` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id_1` BIGINT UNSIGNED NOT NULL COMMENT '用户1（较小ID）',
    `user_id_2` BIGINT UNSIGNED NOT NULL COMMENT '用户2（较大ID）',
    `match_score` DECIMAL(5,2) COMMENT '匹配度',
    `matched_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '匹配时间',
    `first_interaction_at` DATETIME COMMENT '首次互动时间',
    `first_message_at` DATETIME COMMENT '首次发消息时间',
    `last_interaction_at` DATETIME COMMENT '最后互动时间',
    `message_count` INT UNSIGNED DEFAULT 0 COMMENT '消息总数',
    `status` TINYINT DEFAULT 1 COMMENT '状态：1-正常 2-已解除 3-已拉黑',
    `unmatched_by` BIGINT COMMENT '解除匹配的用户ID',
    `unmatched_at` DATETIME COMMENT '解除时间',
    `unmatch_reason` VARCHAR(200) COMMENT '解除原因',
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_users` (`user_id_1`, `user_id_2`),
    KEY `idx_user1` (`user_id_1`),
    KEY `idx_user2` (`user_id_2`),
    KEY `idx_status` (`status`),
    KEY `idx_matched_at` (`matched_at`),
    
    CONSTRAINT `fk_match_user1` FOREIGN KEY (`user_id_1`) REFERENCES `users` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_match_user2` FOREIGN KEY (`user_id_2`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='匹配关系表';
```

#### 2.3.3 每日推荐记录表 (daily_recommendations)
```sql
CREATE TABLE `daily_recommendations` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT UNSIGNED NOT NULL,
    `recommended_user_id` BIGINT UNSIGNED NOT NULL,
    `recommend_date` DATE NOT NULL COMMENT '推荐日期',
    `match_score` DECIMAL(5,2) NOT NULL COMMENT '匹配度',
    `rank` TINYINT NOT NULL COMMENT '排名1-8',
    `has_viewed` TINYINT DEFAULT 0 COMMENT '是否已查看',
    `viewed_at` DATETIME COMMENT '查看时间',
    `interaction_type` TINYINT COMMENT '互动类型',
    `interacted_at` DATETIME COMMENT '互动时间',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_date_rank` (`user_id`, `recommend_date`, `rank`),
    KEY `idx_user_date` (`user_id`, `recommend_date`),
    KEY `idx_recommended` (`recommended_user_id`),
    
    CONSTRAINT `fk_recommend_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='每日推荐记录表';
```

### 2.4 消息模块

#### 2.4.1 会话表 (conversations)
```sql
CREATE TABLE `conversations` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `conversation_type` TINYINT DEFAULT 1 COMMENT '会话类型：1-私聊 2-群组',
    `user_id_1` BIGINT UNSIGNED NOT NULL,
    `user_id_2` BIGINT UNSIGNED NOT NULL,
    `last_message_id` BIGINT UNSIGNED COMMENT '最后一条消息ID',
    `last_message_time` DATETIME COMMENT '最后消息时间',
    `unread_count_1` INT UNSIGNED DEFAULT 0 COMMENT '用户1未读数',
    `unread_count_2` INT UNSIGNED DEFAULT 0 COMMENT '用户2未读数',
    `is_pinned_1` TINYINT DEFAULT 0 COMMENT '用户1是否置顶',
    `is_pinned_2` TINYINT DEFAULT 0 COMMENT '用户2是否置顶',
    `is_muted_1` TINYINT DEFAULT 0 COMMENT '用户1是否免打扰',
    `is_muted_2` TINYINT DEFAULT 0 COMMENT '用户2是否免打扰',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_users` (`user_id_1`, `user_id_2`),
    KEY `idx_user1_time` (`user_id_1`, `last_message_time`),
    KEY `idx_user2_time` (`user_id_2`, `last_message_time`),
    
    CONSTRAINT `fk_conv_user1` FOREIGN KEY (`user_id_1`) REFERENCES `users` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_conv_user2` FOREIGN KEY (`user_id_2`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='会话表';
```

#### 2.4.2 消息表 (messages) - 分表设计
```sql
-- 按会话ID哈希分256张表：messages_000 ~ messages_255
CREATE TABLE `messages_000` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `conversation_id` BIGINT UNSIGNED NOT NULL,
    `sender_id` BIGINT UNSIGNED NOT NULL COMMENT '发送者ID',
    `receiver_id` BIGINT UNSIGNED NOT NULL COMMENT '接收者ID',
    `message_type` TINYINT NOT NULL COMMENT '消息类型：1-文本 2-图片 3-语音 4-视频 5-位置 6-系统',
    `content` TEXT COMMENT '文本内容',
    `media_url` VARCHAR(500) COMMENT '媒体文件URL',
    `media_duration` INT COMMENT '媒体时长(秒)',
    `media_size` INT COMMENT '媒体大小(字节)',
    `extra_data` JSON COMMENT '额外数据',
    `is_read` TINYINT DEFAULT 0 COMMENT '是否已读',
    `read_at` DATETIME COMMENT '阅读时间',
    `is_recalled` TINYINT DEFAULT 0 COMMENT '是否撤回',
    `recalled_at` DATETIME COMMENT '撤回时间',
    `is_deleted_1` TINYINT DEFAULT 0 COMMENT '用户1是否删除',
    `is_deleted_2` TINYINT DEFAULT 0 COMMENT '用户2是否删除',
    `seq` BIGINT UNSIGNED NOT NULL COMMENT '消息序列号（用于排序）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_conversation_seq` (`conversation_id`, `seq`),
    KEY `idx_conversation_time` (`conversation_id`, `created_at`),
    KEY `idx_sender` (`sender_id`),
    KEY `idx_receiver` (`receiver_id`),
    KEY `idx_created_at` (`created_at`),
    
    CONSTRAINT `fk_msg_conv` FOREIGN KEY (`conversation_id`) REFERENCES `conversations` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='消息表';
```

#### 2.4.3 消息敏感词检测表 (message_sensitve_words)
```sql
CREATE TABLE `message_sensitve_words` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `message_id` BIGINT UNSIGNED NOT NULL,
    `word` VARCHAR(100) NOT NULL COMMENT '敏感词',
    `word_type` VARCHAR(50) COMMENT '敏感词类型：PHONE/WECHAT/QQ/BADWORD',
    `confidence` DECIMAL(4,3) COMMENT '置信度',
    `is_blocked` TINYINT DEFAULT 0 COMMENT '是否被拦截',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    KEY `idx_message` (`message_id`),
    KEY `idx_word` (`word`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='消息敏感词检测表';
```

### 2.5 活动模块

#### 2.5.1 线下活动表 (offline_events)
```sql
CREATE TABLE `offline_events` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `event_code` VARCHAR(50) NOT NULL COMMENT '活动编号',
    `event_name` VARCHAR(200) NOT NULL COMMENT '活动名称',
    `event_type` TINYINT NOT NULL COMMENT '活动类型：1-相亲会 2-主题派对 3-户外拓展',
    `status` TINYINT DEFAULT 1 COMMENT '状态：0-草稿 1-报名中 2-报名截止 3-进行中 4-已结束 5-取消',
    
    -- 时间地点
    `event_date` DATE NOT NULL COMMENT '活动日期',
    `start_time` TIME NOT NULL COMMENT '开始时间',
    `end_time` TIME NOT NULL COMMENT '结束时间',
    `province` VARCHAR(50) NOT NULL,
    `city` VARCHAR(50) NOT NULL,
    `district` VARCHAR(50),
    `address` VARCHAR(200) NOT NULL COMMENT '详细地址',
    `venue_name` VARCHAR(100) COMMENT '场地名称',
    `longitude` DECIMAL(10,7) COMMENT '经度',
    `latitude` DECIMAL(10,7) COMMENT '纬度',
    
    -- 参与人数
    `max_participants` INT UNSIGNED NOT NULL COMMENT '最大人数',
    `min_participants` INT UNSIGNED DEFAULT 10 COMMENT '最小人数',
    `registered_count` INT UNSIGNED DEFAULT 0 COMMENT '已报名人数',
    `checked_in_count` INT UNSIGNED DEFAULT 0 COMMENT '已签到人数',
    
    -- 报名条件
    `gender_requirement` TINYINT COMMENT '性别要求：0-不限 1-男 2-女',
    `age_min` TINYINT COMMENT '最小年龄',
    `age_max` TINYINT COMMENT '最大年龄',
    `education_requirement` TINYINT COMMENT '学历要求',
    `income_requirement` VARCHAR(20) COMMENT '收入要求',
    `marital_requirement` TINYINT COMMENT '婚姻状况要求',
    `other_requirements` TEXT COMMENT '其他要求',
    
    -- 费用信息
    `deposit_amount` DECIMAL(10,2) NOT NULL DEFAULT 200.00 COMMENT '保证金金额',
    `is_deposit_refundable` TINYINT DEFAULT 1 COMMENT '保证金是否可退',
    `ticket_price` DECIMAL(10,2) DEFAULT 0.00 COMMENT '门票价格',
    
    -- 活动详情
    `cover_image_url` VARCHAR(500) COMMENT '封面图',
    `description` TEXT COMMENT '活动描述',
    `schedule` JSON COMMENT '活动流程JSON',
    `highlights` JSON COMMENT '活动亮点JSON',
    `notice` TEXT COMMENT '注意事项',
    
    -- 组织者
    `organizer_id` BIGINT COMMENT '组织者ID（红娘）',
    `organizer_name` VARCHAR(100),
    `organizer_phone` VARCHAR(20),
    
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_event_code` (`event_code`),
    KEY `idx_status` (`status`),
    KEY `idx_city_date` (`city`, `event_date`),
    KEY `idx_date` (`event_date`),
    KEY `idx_organizer` (`organizer_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='线下活动表';
```

#### 2.5.2 活动报名表 (event_registrations)
```sql
CREATE TABLE `event_registrations` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `event_id` BIGINT UNSIGNED NOT NULL,
    `user_id` BIGINT UNSIGNED NOT NULL,
    `registration_no` VARCHAR(50) NOT NULL COMMENT '报名编号',
    
    -- 报名状态
    `status` TINYINT DEFAULT 1 COMMENT '状态：1-已报名 2-已支付 3-已取消 4-已签到 5-已完成 6-已退款',
    `registered_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '报名时间',
    
    -- 支付信息
    `deposit_paid` TINYINT DEFAULT 0 COMMENT '保证金是否已支付',
    `payment_order_no` VARCHAR(100) COMMENT '支付订单号',
    `payment_amount` DECIMAL(10,2) COMMENT '支付金额',
    `payment_time` DATETIME COMMENT '支付时间',
    `payment_channel` VARCHAR(20) COMMENT '支付渠道：wechat/alipay',
    
    -- 签到信息
    `checked_in` TINYINT DEFAULT 0 COMMENT '是否已签到',
    `checked_in_at` DATETIME COMMENT '签到时间',
    `check_in_code` VARCHAR(50) COMMENT '签到码',
    
    -- 退款信息
    `refund_status` TINYINT DEFAULT 0 COMMENT '退款状态：0-未退款 1-退款中 2-已退款',
    `refund_amount` DECIMAL(10,2) COMMENT '退款金额',
    `refund_time` DATETIME COMMENT '退款时间',
    `refund_reason` VARCHAR(200) COMMENT '退款原因',
    
    -- 评价信息
    `is_rated` TINYINT DEFAULT 0 COMMENT '是否已评价',
    `rating` TINYINT COMMENT '评分1-5',
    `comment` VARCHAR(500) COMMENT '评价内容',
    `rated_at` DATETIME COMMENT '评价时间',
    
    `cancel_reason` VARCHAR(200) COMMENT '取消原因',
    `cancelled_at` DATETIME COMMENT '取消时间',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_event_user` (`event_id`, `user_id`),
    UNIQUE KEY `uk_reg_no` (`registration_no`),
    KEY `idx_event_id` (`event_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_status` (`status`),
    
    CONSTRAINT `fk_reg_event` FOREIGN KEY (`event_id`) REFERENCES `offline_events` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_reg_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='活动报名表';
```

---

## 3. Redis缓存设计

### 3.1 缓存Key规范

```
# 用户信息缓存
user:profile:{user_id}              -> Hash   用户基础信息   TTL: 1小时
user:session:{token}                -> String JWT会话信息   TTL: 2小时
user:refresh:{token}                -> String RefreshToken TTL: 7天

# 验证码缓存
sms:code:{phone}                    -> String 短信验证码    TTL: 5分钟
sms:count:{phone}                   -> String 发送次数      TTL: 24小时
login:fail:{user_id}                -> String 登录失败次数  TTL: 30分钟

# 匹配相关缓存
match:daily:{user_id}:{date}        -> List   每日推荐列表 TTL: 48小时
match:pool:{user_id}                -> ZSet   匹配池排序   TTL: 24小时
match:mutual:{user_id}              -> Set    双向匹配用户 TTL: 永久

# 消息相关缓存
msg:unread:{user_id}                -> Hash   未读消息数   TTL: 永久
msg:recent:{user_id}                -> List   最近联系人   TTL: 7天
msg:seq:{conversation_id}           -> String 消息序列号   TTL: 永久

# 在线状态
online:{user_id}                    -> String 在线状态     TTL: 10分钟
online:heartbeat:{user_id}          -> String 心跳时间     TTL: 5分钟

# 限流相关
rate:api:{user_id}:{api}            -> String API调用次数  TTL: 1分钟
rate:sms:{phone}                    -> String 短信发送次数 TTL: 24小时
```

### 3.2 缓存更新策略

**1. Cache-Aside模式（旁路缓存）**
```java
public UserProfile getUserProfile(Long userId) {
    String cacheKey = "user:profile:" + userId;
    
    // 1. 先查缓存
    UserProfile profile = redisTemplate.opsForHash().get(cacheKey);
    if (profile != null) {
        return profile;
    }
    
    // 2. 缓存未命中，查数据库
    profile = userProfileRepository.findByUserId(userId);
    if (profile != null) {
        // 3. 写入缓存
        redisTemplate.opsForHash().putAll(cacheKey, profile);
        redisTemplate.expire(cacheKey, 1, TimeUnit.HOURS);
    }
    
    return profile;
}

public void updateUserProfile(UserProfile profile) {
    // 1. 更新数据库
    userProfileRepository.save(profile);
    
    // 2. 删除缓存（非更新，避免并发问题）
    String cacheKey = "user:profile:" + profile.getUserId();
    redisTemplate.delete(cacheKey);
}
```

**2. 缓存穿透防护**
```java
public UserProfile getUserProfileWithNullCache(Long userId) {
    String cacheKey = "user:profile:" + userId;
    String nullCacheKey = cacheKey + ":null";
    
    // 检查空值缓存
    if (redisTemplate.hasKey(nullCacheKey)) {
        return null;
    }
    
    UserProfile profile = redisTemplate.opsForHash().get(cacheKey);
    if (profile != null) {
        return profile;
    }
    
    profile = userProfileRepository.findByUserId(userId);
    if (profile != null) {
        redisTemplate.opsForHash().putAll(cacheKey, profile);
        redisTemplate.expire(cacheKey, 1, TimeUnit.HOURS);
    } else {
        // 缓存空值，防止穿透
        redisTemplate.opsForValue().set(nullCacheKey, "1", 5, TimeUnit.MINUTES);
    }
    
    return profile;
}
```

---

## 4. 索引优化策略

### 4.1 慢查询优化

**场景1：按条件筛选用户**
```sql
-- 原始查询（慢）
SELECT * FROM user_profiles 
WHERE gender = 2 AND age BETWEEN 25 AND 30 
AND current_city = '上海' AND real_name_verified = 2
ORDER BY vip_level DESC, created_at DESC
LIMIT 20;

-- 优化后（使用复合索引）
CREATE INDEX idx_search ON user_profiles(
    gender, 
    current_city, 
    real_name_verified, 
    age,
    vip_level,
    created_at
);
```

**场景2：查找匹配用户**
```sql
-- 使用覆盖索引
CREATE INDEX idx_match ON match_interactions(
    user_id, 
    interaction_type, 
    is_mutual
) INCLUDE (target_user_id, match_score, created_at);
```

### 4.2 分区表设计

**消息表按月分区**
```sql
CREATE TABLE messages (
    -- 字段定义
) PARTITION BY RANGE (UNIX_TIMESTAMP(created_at)) (
    PARTITION p202401 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p202402 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01')),
    PARTITION p202403 VALUES LESS THAN (UNIX_TIMESTAMP('2024-04-01')),
    -- 自动创建新分区
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## 5. 数据迁移与备份策略

### 5.1 备份方案

**每日全量备份**
```bash
#!/bin/bash
BACKUP_DIR="/backup/mysql/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 全量备份
mysqldump --single-transaction --master-data=2 \
  -u backup -p'password' \
  --databases sheqiujing_user sheqiujing_match sheqiujing_message \
  | gzip > $BACKUP_DIR/full_backup.sql.gz

# 保留最近30天备份
find /backup/mysql -type d -mtime +30 -exec rm -rf {} \;
```

**实时增量备份（Binlog）**
```bash
# 开启binlog
[mysqld]
server_id=1
log_bin=/var/log/mysql/mysql-bin
binlog_format=ROW
expire_logs_days=7
max_binlog_size=500M
```

### 5.2 数据归档

**历史消息归档**
```sql
-- 归档3个月前的消息
INSERT INTO messages_archive 
SELECT * FROM messages 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- 删除原表数据
DELETE FROM messages 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- 优化表空间
OPTIMIZE TABLE messages;
```

---

此数据库设计文档涵盖了：
1. 所有核心数据表的详细设计
2. 完整的字段定义和约束
3. 索引优化策略
4. Redis缓存设计
5. 数据迁移与备份方案

所有表结构都遵循了第三范式，同时针对查询性能做了适当的反范式设计。如需进一步了解API接口设计或技术架构方案，请告诉我！