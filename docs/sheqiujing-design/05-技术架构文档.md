# 佘秋婧相亲平台 - 技术架构文档

## 1. 技术架构总览

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Client Layer)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │   Web App   │  │  iOS App    │  │ Android App │                         │
│  │  (Vue3+TS)  │  │  (SwiftUI)  │  │   (Kotlin)  │                         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                         │
│         │                │                │                                 │
│         └────────────────┴────────────────┘                                 │
│                          │                                                  │
│                    CDN + WAF (阿里云)                                        │
└──────────────────────────┼──────────────────────────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────────────────────┐
│                          ▼                                                  │
│                    网关层 (Gateway Layer)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Nginx 集群 (负载均衡)                              │   │
│  │  • SSL终止  • 限流控制  • 静态资源缓存  • 健康检查                     │   │
│  └───────────────────────────┬─────────────────────────────────────────┘   │
│                              │                                              │
│  ┌───────────────────────────▼─────────────────────────────────────────┐   │
│  │                    Spring Cloud Gateway                              │   │
│  │  • 路由转发  • 鉴权校验  • 熔断降级  • 灰度发布                       │   │
│  └───────────────────────────┬─────────────────────────────────────────┘   │
└──────────────────────────────┼──────────────────────────────────────────────┘
                               │
┌──────────────────────────────┼──────────────────────────────────────────────┐
│                              ▼                                              │
│                      业务服务层 (Service Layer)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │
│  │   用户服务      │ │   匹配服务      │ │   消息服务      │               │
│  │  user-service   │ │ match-service   │ │ message-service │               │
│  │                 │ │                 │ │                 │               │
│  │ • 注册登录      │ │ • 推荐算法      │ │ • 即时通讯      │               │
│  │ • 实名认证      │ │ • 匹配计算      │ │ • 消息推送      │               │
│  │ • 资料管理      │ │ • 互动记录      │ │ • 内容审核      │               │
│  └────────┬────────┘ └────────┬────────┘ └────────┬────────┘               │
│           │                   │                   │                        │
│  ┌────────┴────────┐ ┌────────┴────────┐ ┌────────┴────────┐              │
│  │   活动服务      │ │   支付服务      │ │   通知服务      │              │
│  │ event-service   │ │payment-service  │ │ notify-service  │              │
│  │                 │ │                 │ │                 │              │
│  │ • 活动管理      │ │ • 订单管理      │ │ • 短信服务      │              │
│  │ • 报名签到      │ │ • 退款处理      │ │ • 推送服务      │              │
│  │ • 保证金管理    │ │ • 财务对账      │ │ • 邮件服务      │              │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘              │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    公共服务 (Common Services)                        │   │
│  │                                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │   │
│  │  │ 文件服务    │ │ 搜索服务    │ │ 审核服务    │ │ 分析服务    │  │   │
│  │  │  file-svc   │ │ search-svc  │ │  audit-svc  │ │analytics-svc│  │   │
│  │  │  (OSS)      │ │    (ES)     │ │  (AI+人工)  │ │  (报表)     │  │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                               │
┌──────────────────────────────┼──────────────────────────────────────────────┐
│                              ▼                                              │
│                       数据层 (Data Layer)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    MySQL 8.0 集群 (主从架构)                         │   │
│  │                                                                     │   │
│  │   ┌─────────────┐              ┌─────────────┐                     │   │
│  │   │  Master     │◄────────────►│   Slave 1   │                     │   │
│  │   │  (写入)     │   同步复制    │   (读取)    │                     │   │
│  │   └─────────────┘              └──────┬──────┘                     │   │
│  │          │                            │                           │   │
│  │          │                     ┌──────┴──────┐                    │   │
│  │          │                     │   Slave 2   │                    │   │
│  │          │                     │   (读取)    │                    │   │
│  │          │                     └─────────────┘                    │   │
│  │          │                                                        │   │
│  │   [user_db] [match_db] [message_db] [event_db]                    │   │
│  │   (分库分表)                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Redis 7.0 集群                                   │   │
│  │                                                                     │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │   │ Node 1  │  │ Node 2  │  │ Node 3  │  │ Node 4  │             │   │
│  │   │ Master  │  │ Master  │  │ Master  │  │ Master  │             │   │
│  │   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘             │   │
│  │        │            │            │            │                  │   │
│  │   ┌────┴────┐  ┌────┴────┐  ┌────┴────┐  ┌────┴────┐            │   │
│  │   │ Slave   │  │ Slave   │  │ Slave   │  │ Slave   │            │   │
│  │   └─────────┘  └─────────┘  └─────────┘  └─────────┘            │   │
│  │                                                                     │   │
│  │   • Session 缓存  • 热点数据  • 限流计数  • 分布式锁               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │   Elasticsearch 8.x         │  │   RabbitMQ 集群                      │  │
│  │   (用户搜索)                 │  │   (消息队列)                         │  │
│  │                             │  │                                      │  │
│  │   • 全文检索                │  │   • 异步任务                         │  │
│  │   • 条件筛选                │  │   • 削峰填谷                         │  │
│  │   • 智能推荐                │  │   • 服务解耦                         │  │
│  └─────────────────────────────┘  └─────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                               │
┌──────────────────────────────┼──────────────────────────────────────────────┐
│                              ▼                                              │
│                      基础设施层 (Infrastructure)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Docker + Kubernetes                              │   │
│  │                                                                     │   │
│  │   • 容器化部署  • 自动扩缩容  • 服务发现  • 负载均衡               │   │
│  │   • 健康检查    • 滚动更新    • 故障自愈  • 资源监控               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    监控告警系统 (Prometheus + Grafana)               │   │
│  │                                                                     │   │
│  │   • 系统监控    • 业务指标    • 日志聚合    • 告警通知             │   │
│  │   • APM链路追踪 (SkyWalking)  • 性能分析                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    阿里云基础设施                                    │   │
│  │                                                                     │   │
│  │   • ECS (4核8G x 2)  • SLB 负载均衡  • OSS 对象存储               │   │
│  │   • CDN 加速  • RDS (MySQL)  • Redis 企业版                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 前端技术架构

### 2.1 技术栈选择

```
┌─────────────────────────────────────────────────────────────┐
│                    前端技术栈                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  框架层                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Vue 3.4 + TypeScript 5.x                           │   │
│  │  • Composition API                                  │   │
│  │  • `<script setup>` 语法                            │   │
│  │  • TypeScript 严格模式                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  构建工具                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Vite 5.x                                           │   │
│  │  • 极速冷启动 (< 100ms)                             │   │
│  │  • 热模块替换 (HMR)                                 │   │
│  │  • Rollup 打包优化                                  │   │
│  │  • Tree Shaking                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  UI 组件库                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Vant 4.x (移动端)                                  │   │
│  │  Element Plus 2.x (管理后台)                        │   │
│  │  • 按需加载                                         │   │
│  │  • 主题定制                                         │   │
│  │  • TypeScript 支持                                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  状态管理                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Pinia 2.x                                          │   │
│  │  • Store 模块化                                     │   │
│  │  • 持久化存储 (pinia-plugin-persistedstate)        │   │
│  │  • 状态订阅                                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  路由管理                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Vue Router 4.x                                     │   │
│  │  • 路由懒加载                                       │   │
│  │  • 路由守卫                                         │   │
│  │  • 动态路由                                         │   │
│  │  • 过渡动画                                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  HTTP 客户端                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Axios 1.x + 封装                                   │   │
│  │  • 请求/响应拦截器                                  │   │
│  │  • 自动刷新 Token                                   │   │
│  │  • 请求重试                                         │   │
│  │  • 错误处理                                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  实时通信                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Socket.io-client                                   │   │
│  │  • 自动重连                                         │   │
│  │  • 心跳检测                                         │   │
│  │  • 事件订阅                                         │   │
│  │  • 断线补偿                                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  工具库                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • Day.js - 日期处理                                │   │
│  │  • Lodash-es - 工具函数                             │   │
│  │  • VueUse - Vue 组合式函数                          │   │
│  │  • @vueuse/motion - 动画                            │   │
│  │  • Compressor.js - 图片压缩                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 项目结构

```
sheqiujing-frontend/
├── public/                        # 静态资源
│   ├── favicon.ico
│   └── manifest.json
├── src/
│   ├── api/                       # API 接口
│   │   ├── modules/
│   │   │   ├── auth.ts           # 认证相关
│   │   │   ├── user.ts           # 用户相关
│   │   │   ├── matching.ts       # 匹配相关
│   │   │   ├── message.ts        # 消息相关
│   │   │   └── event.ts          # 活动相关
│   │   ├── request.ts            # Axios 封装
│   │   └── types.ts              # API 类型定义
│   │
│   ├── assets/                    # 资源文件
│   │   ├── images/
│   │   ├── icons/
│   │   └── styles/
│   │       ├── variables.scss    # SCSS 变量
│   │       ├── mixins.scss       # SCSS Mixins
│   │       └── index.scss        # 全局样式
│   │
│   ├── components/                # 公共组件
│   │   ├── common/               # 通用组件
│   │   │   ├── AppButton/
│   │   │   ├── AppInput/
│   │   │   ├── AppCard/
│   │   │   └── AppLoading/
│   │   ├── business/             # 业务组件
│   │   │   ├── UserCard/         # 用户卡片
│   │   │   ├── MatchAction/      # 匹配操作
│   │   │   ├── ChatMessage/      # 聊天消息
│   │   │   └── EventCard/        # 活动卡片
│   │   └── layout/               # 布局组件
│   │       ├── AppHeader/
│   │       ├── AppTabbar/
│   │       └── AppSidebar/
│   │
│   ├── composables/               # 组合式函数
│   │   ├── useAuth.ts            # 认证逻辑
│   │   ├── useUser.ts            # 用户数据
│   │   ├── useMatching.ts        # 匹配逻辑
│   │   ├── useMessage.ts         # 消息逻辑
│   │   ├── useSocket.ts          # WebSocket
│   │   └── useUpload.ts          # 文件上传
│   │
│   ├── directives/                # 自定义指令
│   │   ├── permission.ts         # 权限指令
│   │   └── lazyLoad.ts           # 懒加载指令
│   │
│   ├── layouts/                   # 页面布局
│   │   ├── default.vue           # 默认布局
│   │   ├── auth.vue              # 认证页布局
│   │   └── blank.vue             # 空白布局
│   │
│   ├── pages/                     # 页面
│   │   ├── index.vue             # 首页
│   │   ├── login.vue             # 登录
│   │   ├── register.vue          # 注册
│   │   ├── profile/
│   │   │   ├── index.vue         # 我的资料
│   │   │   ├── edit.vue          # 编辑资料
│   │   │   └── settings.vue      # 设置
│   │   ├── matching/
│   │   │   ├── daily.vue         # 每日推荐
│   │   │   └── matches.vue       # 我的匹配
│   │   ├── messages/
│   │   │   ├── index.vue         # 消息列表
│   │   │   └── chat/[id].vue     # 聊天页
│   │   └── events/
│   │       ├── index.vue         # 活动列表
│   │       └── [id].vue          # 活动详情
│   │
│   ├── router/                    # 路由配置
│   │   ├── index.ts              # 路由入口
│   │   ├── routes.ts             # 路由定义
│   │   └── guards.ts             # 路由守卫
│   │
│   ├── stores/                    # Pinia Store
│   │   ├── modules/
│   │   │   ├── user.ts           # 用户状态
│   │   │   ├── auth.ts           # 认证状态
│   │   │   ├── matching.ts       # 匹配状态
│   │   │   └── message.ts        # 消息状态
│   │   └── index.ts              # Store 入口
│   │
│   ├── utils/                     # 工具函数
│   │   ├── storage.ts            # 本地存储封装
│   │   ├── validate.ts           # 表单验证
│   │   ├── format.ts             # 数据格式化
│   │   └── helpers.ts            # 辅助函数
│   │
│   ├── App.vue                    # 根组件
│   ├── main.ts                    # 入口文件
│   └── env.d.ts                   # 类型声明
│
├── .env                           # 环境变量
├── .env.development
├── .env.production
├── index.html
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.ts
```

### 2.3 性能优化策略

**1. 加载优化**
```typescript
// 路由懒加载
const routes = [
  {
    path: '/matching',
    component: () => import('@/pages/matching/index.vue'),
    meta: { 
      lazy: true,
      preload: true  // 预加载
    }
  }
]

// 组件异步加载
const UserCard = defineAsyncComponent({
  loader: () => import('@/components/business/UserCard/index.vue'),
  loadingComponent: LoadingSkeleton,
  delay: 200,
  timeout: 3000
})
```

**2. 图片优化**
```vue
<template>
  <!-- 懒加载 + 响应式图片 -->
  <img
    v-lazy="imageUrl"
    :srcset="`${imageUrl}?x-oss-process=image/resize,w_320 320w,
               ${imageUrl}?x-oss-process=image/resize,w_640 640w,
               ${imageUrl}?x-oss-process=image/resize,w_960 960w`"
    sizes="(max-width: 320px) 320px,
           (max-width: 640px) 640px,
           960px"
    alt="用户照片"
  />
</template>
```

**3. 缓存策略**
```typescript
// HTTP 缓存控制
const apiClient = axios.create({
  headers: {
    'Cache-Control': 'max-age=3600'
  }
})

// 接口数据缓存
const { data } = useQuery({
  queryKey: ['userProfile', userId],
  queryFn: () => fetchUserProfile(userId),
  staleTime: 5 * 60 * 1000,  // 5分钟内数据视为新鲜
  cacheTime: 30 * 60 * 1000   // 缓存保留30分钟
})
```

---

## 3. 后端技术架构

### 3.1 技术栈选择

```
┌─────────────────────────────────────────────────────────────┐
│                    后端技术栈                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  核心框架                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Spring Boot 2.7.x                                  │   │
│  │  • Java 17 LTS                                      │   │
│  │  • Spring Web MVC                                   │   │
│  │  • Spring Data JPA                                  │   │
│  │  • Spring Security                                  │   │
│  │  • Spring Validation                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  微服务架构                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Spring Cloud 2021.0.x                              │   │
│  │  • Gateway - 网关                                   │   │
│  │  • Nacos - 服务注册与配置中心                       │   │
│  │  • Sentinel - 熔断限流                              │   │
│  │  • Seata - 分布式事务                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  数据访问                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • MyBatis Plus 3.5.x - ORM 框架                    │   │
│  │  • ShardingSphere 5.x - 分库分表                    │   │
│  │  • Redis Lettuce - Redis 客户端                     │   │
│  │  • Redisson - 分布式锁                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  消息队列                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  RabbitMQ / RocketMQ                                │   │
│  │  • 消息可靠投递                                     │   │
│  │  • 延迟队列                                         │   │
│  │  • 顺序消息                                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  缓存与搜索                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • Redis - 缓存、会话、限流                         │   │
│  │  • Caffeine - 本地缓存                              │   │
│  │  • Elasticsearch - 全文检索                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  安全与认证                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • JWT (jjwt) - Token 认证                          │   │
│  │  • BCrypt - 密码加密                                │   │
│  │  • AES-256 - 敏感数据加密                           │   │
│  │  • Google Tink - 加密工具库                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  工具库                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  • Lombok - 代码简化                                │   │
│  │  • MapStruct - 对象映射                             │   │
│  │  • Hutool - Java 工具包                             │   │
│  │  • Guava - Google 工具库                            │   │
│  │  • Apache Commons - 通用工具                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 项目结构

```
sheqiujing-backend/
├── sheqiujing-common/              # 公共模块
│   ├── src/main/java/
│   │   └── com/sheqiujing/common/
│   │       ├── constant/          # 常量定义
│   │       ├── dto/               # 数据传输对象
│   │       ├── enums/             # 枚举类
│   │       ├── exception/         # 异常定义
│   │       ├── result/            # 统一响应
│   │       ├── util/              # 工具类
│   │       └── validator/         # 自定义验证
│   └── pom.xml
│
├── sheqiujing-gateway/             # 网关服务
│   └── src/main/java/
│       └── com/sheqiujing/gateway/
│           ├── config/            # 网关配置
│           ├── filter/            # 过滤器
│           └── handler/           # 处理器
│
├── sheqiujing-user-service/        # 用户服务
│   └── src/main/java/
│       └── com/sheqiujing/user/
│           ├── controller/        # 控制器
│           ├── service/           # 业务层
│           │   └── impl/
│           ├── repository/        # 数据访问层
│           ├── entity/            # 实体类
│           ├── dto/               # DTO
│           ├── vo/                # VO
│           ├── mapper/            # MapStruct
│           ├── config/            # 配置类
│           └── util/              # 工具类
│
├── sheqiujing-matching-service/    # 匹配服务
├── sheqiujing-message-service/     # 消息服务
├── sheqiujing-event-service/       # 活动服务
├── sheqiujing-payment-service/     # 支付服务
├── sheqiujing-notify-service/      # 通知服务
│
└── pom.xml                         # 父POM
```

### 3.3 核心代码示例

**统一响应封装**
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Result<T> {
    private Integer code;
    private String message;
    private T data;
    private Long timestamp;
    private String requestId;

    public static <T> Result<T> success(T data) {
        return new Result<>(200, "success", data, 
            System.currentTimeMillis(), MDC.get("requestId"));
    }

    public static <T> Result<T> error(ErrorCode errorCode) {
        return new Result<>(errorCode.getCode(), errorCode.getMessage(), 
            null, System.currentTimeMillis(), MDC.get("requestId"));
    }
}
```

**JWT 认证过滤器**
```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtTokenProvider tokenProvider;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
            HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {
        
        String token = extractToken(request);
        
        if (StringUtils.hasText(token) && tokenProvider.validateToken(token)) {
            Authentication authentication = tokenProvider.getAuthentication(token);
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        
        filterChain.doFilter(request, response);
    }

    private String extractToken(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

**分布式锁实现**
```java
@Service
public class DistributedLockService {

    @Autowired
    private RedissonClient redissonClient;

    public <T> T executeWithLock(String lockKey, long waitTime, 
            long leaseTime, Supplier<T> supplier) {
        RLock lock = redissonClient.getLock(lockKey);
        try {
            boolean acquired = lock.tryLock(waitTime, leaseTime, TimeUnit.SECONDS);
            if (!acquired) {
                throw new BusinessException("获取锁失败，请稍后重试");
            }
            return supplier.get();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new BusinessException("获取锁被中断");
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

---

## 4. 部署架构

### 4.1 服务器规划

```
生产环境服务器配置 (阿里云)

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  SLB (负载均衡)                                                              │
│  • 规格: 标准型 SLB                                                          │
│  • 带宽: 100Mbps                                                             │
│  • 并发: 50,000 CPS                                                          │
│                              │                                              │
│            ┌─────────────────┼─────────────────┐                           │
│            │                 │                 │                           │
│            ▼                 ▼                 ▼                           │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐           │
│  │   应用服务器 1    │ │   应用服务器 2    │ │   应用服务器 3    │           │
│  │  (ECS 4核8G)     │ │  (ECS 4核8G)     │ │  (ECS 4核8G)     │           │
│  │                  │ │                  │ │                  │           │
│  │  Docker + K8s    │ │  Docker + K8s    │ │  Docker + K8s    │           │
│  │  运行所有服务     │ │  运行所有服务     │ │  运行所有服务     │           │
│  │                  │ │                  │ │                  │           │
│  │  带宽: 10Mbps    │ │  带宽: 10Mbps    │ │  带宽: 10Mbps    │           │
│  └──────────────────┘ └──────────────────┘ └──────────────────┘           │
│                                                                             │
│  数据库服务器                                                               │
│  ┌──────────────────┐ ┌──────────────────┐                                 │
│  │   RDS MySQL      │ │   Redis 企业版    │                                 │
│  │  (8核16G)        │ │  (16GB内存)      │                                 │
│  │                  │ │                  │                                 │
│  │  主从架构         │ │  集群模式         │                                 │
│  │  存储: 500GB SSD │ │  主从+哨兵        │                                 │
│  │  自动备份         │ │  持久化开启       │                                 │
│  └──────────────────┘ └──────────────────┘                                 │
│                                                                             │
│  存储与搜索                                                                 │
│  ┌──────────────────┐ ┌──────────────────┐                                 │
│  │   OSS 对象存储   │ │ Elasticsearch    │                                 │
│  │                  │ │  (4核8G x 3节点) │                                 │
│  │  标准存储        │ │                  │                                 │
│  │  CDN加速         │ │  集群部署         │                                 │
│  │  图片/视频存储    │ │  用户搜索索引     │                                 │
│  └──────────────────┘ └──────────────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

月度预估费用: ¥8,000 - ¥12,000
```

### 4.2 Docker Compose 配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  # Nginx 网关
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/html:/usr/share/nginx/html
    depends_on:
      - gateway
    networks:
      - sheqiujing-network

  # 网关服务
  gateway:
    image: sheqiujing/gateway:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - NACOS_SERVER_ADDR=nacos:8848
    depends_on:
      - nacos
    networks:
      - sheqiujing-network

  # 用户服务
  user-service:
    image: sheqiujing/user-service:latest
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
      - NACOS_SERVER_ADDR=nacos:8848
    depends_on:
      - mysql
      - redis
      - nacos
    networks:
      - sheqiujing-network

  # 匹配服务
  matching-service:
    image: sheqiujing/matching-service:latest
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
      - ES_HOST=elasticsearch
    depends_on:
      - mysql
      - redis
      - elasticsearch
    networks:
      - sheqiujing-network

  # MySQL
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=your_password
      - MYSQL_DATABASE=sheqiujing
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    networks:
      - sheqiujing-network

  # Redis
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - sheqiujing-network

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - sheqiujing-network

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:8.5.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - sheqiujing-network

  # Nacos
  nacos:
    image: nacos/nacos-server:v2.2.0
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=your_password
    ports:
      - "8848:8848"
    networks:
      - sheqiujing-network

volumes:
  mysql-data:
  redis-data:
  rabbitmq-data:
  elasticsearch-data:

networks:
  sheqiujing-network:
    driver: bridge
```

---

## 5. 安全架构

### 5.1 安全体系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         安全防御体系                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  第一层: 网络层安全                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 阿里云 WAF - Web应用防火墙                                        │   │
│  │  • DDoS 高防 - 流量清洗                                              │   │
│  │  • 入侵检测 (IDS)                                                    │   │
│  │  • 安全组规则 - 端口访问控制                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│  第二层: 应用层安全                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • HTTPS/TLS 1.3 全站加密                                           │   │
│  │  • JWT Token 认证                                                    │   │
│  │  • 接口限流 (Rate Limiting)                                          │   │
│  │  • 请求签名验证                                                      │   │
│  │  • 防重放攻击                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│  第三层: 业务层安全                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • SQL注入防护 (PreparedStatement)                                   │   │
│  │  • XSS攻击防护 (输入过滤、输出转义)                                   │   │
│  │  • CSRF Token 验证                                                   │   │
│  │  • 敏感数据加密 (AES-256)                                            │   │
│  │  • 密码强度检测                                                      │   │
│  │  • 异常行为检测                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│  第四层: 数据层安全                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 数据库访问控制                                                    │   │
│  │  • 敏感字段脱敏                                                      │   │
│  │  • 数据备份加密                                                      │   │
│  │  • 审计日志记录                                                      │   │
│  │  • 数据分级分类                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 数据加密方案

```java
@Component
public class EncryptionService {

    @Value("${encryption.aes.key}")
    private String aesKey;

    private final AesGcmJce aesGcm;

    public EncryptionService() {
        this.aesGcm = new AesGcmJce(aesKey.getBytes(StandardCharsets.UTF_8));
    }

    /**
     * 加密敏感数据
     */
    public String encrypt(String plaintext) {
        try {
            byte[] ciphertext = aesGcm.encrypt(
                plaintext.getBytes(StandardCharsets.UTF_8), 
                null
            );
            return Base64.getEncoder().encodeToString(ciphertext);
        } catch (Exception e) {
            throw new EncryptionException("加密失败", e);
        }
    }

    /**
     * 解密敏感数据
     */
    public String decrypt(String ciphertext) {
        try {
            byte[] decoded = Base64.getDecoder().decode(ciphertext);
            byte[] plaintext = aesGcm.decrypt(decoded, null);
            return new String(plaintext, StandardCharsets.UTF_8);
        } catch (Exception e) {
            throw new EncryptionException("解密失败", e);
        }
    }

    /**
     * 脱敏处理
     */
    public String mask(String data, DataType type) {
        switch (type) {
            case PHONE:
                return data.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
            case ID_CARD:
                return data.replaceAll("(\\d{6})\\d{8}(\\d{4})", "$1********$2");
            case NAME:
                return data.charAt(0) + "*" + data.substring(2);
            default:
                return data;
        }
    }
}
```

---

## 6. 监控与运维

### 6.1 监控体系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         监控告警体系                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  指标采集 (Prometheus)                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 系统指标: CPU、内存、磁盘、网络                                    │   │
│  │  • 应用指标: QPS、响应时间、错误率、GC                               │   │
│  │  • 业务指标: 注册数、匹配数、消息数、付费转化                         │   │
│  │  • 自定义指标: 接口调用次数、缓存命中率                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│  可视化展示 (Grafana)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 系统监控大盘                                                      │   │
│  │  • 业务指标大盘                                                      │   │
│  │  • 接口性能大盘                                                      │   │
│  │  • 错误日志大盘                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│  日志管理 (ELK Stack)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • Filebeat - 日志收集                                               │   │
│  │  • Logstash - 日志处理                                               │   │
│  │  • Elasticsearch - 日志存储                                          │   │
│  │  • Kibana - 日志查询                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│  链路追踪 (SkyWalking)                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 分布式链路追踪                                                    │   │
│  │  • 性能瓶颈分析                                                      │   │
│  │  • 依赖拓扑图                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                              │                                              │
│  告警通知 (AlertManager)                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 钉钉/企业微信/邮件                                                │   │
│  │  • 分级告警: P0-紧急 P1-重要 P2-一般                                 │   │
│  │  • 告警收敛和静默                                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 关键监控指标

| 指标类别 | 指标名称 | 告警阈值 | 说明 |
|----------|----------|----------|------|
| 系统 | CPU使用率 | > 80% | 持续5分钟 |
| 系统 | 内存使用率 | > 85% | 持续5分钟 |
| 系统 | 磁盘使用率 | > 85% | - |
| 应用 | 接口响应时间 | > 500ms | P99 |
| 应用 | 错误率 | > 1% | 持续3分钟 |
| 应用 | QPS | < 100 | 异常下降 |
| 业务 | 注册转化率 | < 30% | 日环比 |
| 业务 | 支付成功率 | < 95% | - |
| 数据库 | 慢查询数量 | > 10/分钟 | - |
| 数据库 | 连接池使用率 | > 80% | - |

---

## 7. 性能优化

### 7.1 性能指标目标

| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| 首屏加载时间 | < 2秒 | Lighthouse |
| 接口响应时间 (P99) | < 300ms | Prometheus |
| 并发用户数 | 5000+ | JMeter |
| 系统吞吐量 | 1000 TPS | JMeter |
| 数据库查询时间 | < 50ms | Slow Log |
| 缓存命中率 | > 90% | Redis INFO |

### 7.2 优化策略

**1. 数据库优化**
- 读写分离，主库写、从库读
- 热点数据Redis缓存
- 分页查询优化（延迟关联）
- 索引优化（EXPLAIN分析）
- 分库分表（ShardingSphere）

**2. 缓存策略**
- 多级缓存：本地缓存(Caffeine) + 分布式缓存(Redis)
- 缓存预热
- 缓存更新策略：Cache-Aside + 延迟双删
- 热点数据永不过期

**3. 异步处理**
- 短信发送 - 消息队列异步
- 图片处理 - 异步任务
- 消息推送 - 异步批量
- 统计计算 - 离线任务

**4. CDN加速**
- 静态资源CDN分发
- 图片OSS + CDN
- 视频点播加速

---

此技术架构文档涵盖了：
1. 完整的系统架构图
2. 前后端技术选型和项目结构
3. Docker部署方案
4. 安全架构和数据加密
5. 监控告警体系
6. 性能优化策略

至此，佘秋婧相亲平台的完整设计方案已全部完成！所有文档已保存在 `docs/sheqiujing-design/` 目录下。